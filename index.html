<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamsy - تجربة مشاهدة فريدة</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ef4444'%3E%3Cpath fill-rule='evenodd' d='M4.5 5.653c0-1.427 1.529-2.33 2.779-1.643l11.54 6.347c1.295.712 1.295 2.573 0 3.286L7.28 19.99c-1.25.687-2.779-.217-2.779-1.643V5.653Z' clip-rule='evenodd' /%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

    <style>
        body {
            font-family: 'Cairo', 'Roboto', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f8f9fa;
        }
        .body-no-scroll {
            overflow: hidden;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        .line-clamp-3 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 3; }

        #sidebar::-webkit-scrollbar { width: 6px; }
        #sidebar::-webkit-scrollbar-track { background: transparent; }
        #sidebar::-webkit-scrollbar-thumb { background: #ced4da; border-radius: 3px;}
        #sidebar:hover::-webkit-scrollbar-thumb { background: #adb5bd; }

        .sidebar-link-active { background-color: #e9ecef; font-weight: 600; }
        .sidebar-link-active span, .sidebar-link-active svg { color: #c92a2a; }
        .sidebar-link-active .material-icons, .sidebar-link-active .material-icons-outlined { font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 0, 'opsz' 48; }

        .category-button.active { background-color: #c92a2a !important; color: white !important; border-color: #c92a2a !important; }
        .category-button:not(.active) { background-color: #e9ecef; color: #343a40; border-color: #dee2e6; }
        .category-button:not(.active):hover { background-color: #ced4da; }

        .input-style { @apply w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-red-500; }
        .file-input-enhanced { @apply block w-full text-sm text-gray-600 p-3 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none focus:ring-2 focus:ring-red-300 focus:border-red-500; }
        .file-input-enhanced::file-selector-button { @apply mr-4 py-2 px-5 rounded-md border-0 text-sm font-semibold bg-red-600 text-white hover:bg-red-700 cursor-pointer transition-colors; }

        .material-icons-outlined { font-family: 'Material Icons Outlined'; font-weight: normal; font-style: normal; font-size: 24px; line-height: 1; letter-spacing: normal; text-transform: none; display: inline-block; white-space: nowrap; word-wrap: normal; direction: ltr; -webkit-font-feature-settings: 'liga'; -webkit-font-smoothing: antialiased; }
        .action-button-active .material-icons-outlined { font-family: 'Material Icons'; font-variation-settings: 'FILL' 1; }
        .action-button-active.like { @apply text-blue-600 font-bold; }
        .action-button-active.dislike { @apply text-red-700 font-bold; }

        #sidebar.md\:w-16 .sidebar-link .material-icons,
        #sidebar.md\:w-16 .sidebar-link .material-icons-outlined,
        #sidebar.lg\:w-16 .sidebar-link .material-icons,
        #sidebar.lg\:w-16 .sidebar-link .material-icons-outlined {
            @apply ml-0;
        }
        #sidebar.md\:w-16 .sidebar-link span:not(.lg\:inline),
        #sidebar.lg\:w-16 .sidebar-link span:not(.lg\:inline)
        {
            @apply md:hidden;
        }
         #sidebar.lg\:w-16 .sidebar-link span.lg\:inline { @apply lg:hidden; }


        #sidebar.md\:w-64 .sidebar-link .material-icons,
        #sidebar.md\:w-64 .sidebar-link .material-icons-outlined,
        #sidebar.lg\:w-64 .sidebar-link .material-icons,
        #sidebar.lg\:w-64 .sidebar-link .material-icons-outlined {
            @apply ml-4;
        }
        #sidebar.md\:w-64 .sidebar-link span,
        #sidebar.lg\:w-64 .sidebar-link span.hidden.lg\:inline
        {
            @apply md:inline-block;
        }
        #sidebar.lg\:w-64 .sidebar-link span.hidden.lg\:inline { @apply lg:inline; }


        #channel-page-section { background-color: #f1f3f5; }
        .channel-cover-photo { @apply w-full h-40 sm:h-52 md:h-64 lg:h-80 bg-gray-400 object-cover rounded-b-lg shadow-md; }
        .channel-header-card { @apply bg-white p-4 md:p-6 rounded-lg shadow-lg -mt-16 sm:-mt-20 md:-mt-24 relative z-10 border border-gray-200; }

        .streamsy-original-badge {
            @apply absolute top-2 right-2 bg-gradient-to-r from-red-500 to-orange-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow-lg transform transition-all hover:scale-105;
            letter-spacing: 0.5px;
        }

        .shorts-player-container { @apply w-full h-full flex items-center justify-center bg-black; }
        .shorts-video { @apply max-w-full max-h-full object-contain; }
        .shorts-ui-overlay { @apply absolute inset-0 flex flex-col justify-between p-4 text-white; }
        .streamsy-gradient-text { background: -webkit-linear-gradient(#ef4444, #f97316); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        #autoplay-overlay { @apply absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center text-white p-4 z-30 hidden; }
        #autoplay-countdown { @apply text-lg mb-2; }
        #autoplay-next-title { @apply text-sm font-semibold mb-4 line-clamp-2; }
        .autoplay-button { @apply px-4 py-2 rounded-md text-sm font-medium transition-colors; }

        .player-control-button { @apply p-1.5 sm:p-2 text-gray-600 hover:text-red-600 rounded-full hover:bg-gray-100 transition-colors; }

        #video-options-dropdown { @apply hidden absolute left-0 mt-1 w-48 bg-white rounded-md shadow-lg border z-30 py-1; }


        @media (max-width: 767px) {
            #video-grid-area, #channel-page-section > div, #subscriptions-section, #liked-videos-section, #history-section, #trending-section, #live-now-section { /* Added live-now-section */
                @apply px-2 py-3 sm:px-3 sm:py-4;
            }
            #categories-bar-container {
                @apply px-2 py-2 sm:px-3;
            }
            #video-player-section .p-4.md\:p-5 {
                @apply p-3;
            }
            #upload-video-modal .max-w-3xl {
                @apply max-w-xl;
            }
            #search-input {
                @apply text-xs sm:text-sm;
            }
            .channel-header-card {
                @apply px-3;
            }
        }
        /* Video.js customizations */
        .video-js .vjs-control-bar {
            background-color: rgba(43, 51, 63, 0.7) !important; /* Darker control bar */
            font-size: 0.9rem;
        }
        .video-js .vjs-play-progress, .video-js .vjs-volume-level {
            background-color: #ef4444 !important; /* Streamsy red */
        }
        .video-js .vjs-slider {
             background-color: rgba(255, 255, 255, 0.3) !important;
        }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
</head>
<body class="text-gray-900 flex flex-col min-h-screen">

    <header class="bg-white h-16 flex items-center justify-between px-2 sm:px-4 sticky top-0 z-[100] border-b border-gray-200 shadow-lg">
        <div class="flex items-center">
            <button id="menu-button" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none ml-1 text-gray-700">
                <span class="material-icons">menu</span>
            </button>
            <a href="#" id="logo-home-button" class="flex items-center shrink-0 ml-1 md:ml-2 text-red-600 hover:text-red-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 md:w-8 md:h-8">
                    <path fill-rule="evenodd" d="M4.5 5.653c0-1.427 1.529-2.33 2.779-1.643l11.54 6.347c1.295.712 1.295 2.573 0 3.286L7.28 19.99c-1.25.687-2.779-.217-2.779-1.643V5.653Z" clip-rule="evenodd" />
                </svg>
                <span class="text-lg md:text-xl font-bold ml-1 tracking-tighter streamsy-gradient-text">Streamsy</span>
            </a>
        </div>

        <div class="flex-1 max-w-[150px] sm:max-w-xs md:max-w-md lg:max-w-xl mx-1 sm:mx-2">
            <form class="flex" onsubmit="event.preventDefault(); handleSearch();">
                <input type="search" id="search-input" placeholder="ابحث..." class="flex-1 min-w-0 bg-gray-100 border-2 border-gray-300 text-gray-800 py-1.5 px-2 sm:py-2 sm:px-3 rounded-r-full focus:outline-none focus:border-red-500 focus:bg-white focus:ring-2 focus:ring-red-300 placeholder-gray-500 text-xs">
                <button type="submit" class="bg-gray-200 hover:bg-gray-300 border-2 border-l-0 border-gray-300 text-gray-700 px-2 sm:px-3 rounded-l-full focus:outline-none">
                    <span class="material-icons text-base sm:text-lg">search</span>
                </button>
            </form>
        </div>

        <div class="flex items-center space-x-reverse space-x-0.5 sm:space-x-1">
            <button id="open-upload-modal-button-header" class="p-1.5 sm:p-2 rounded-full hover:bg-gray-100 focus:outline-none text-gray-700 hidden sm:inline-flex" title="إنشاء">
                <span class="material-icons-outlined text-lg sm:text-xl">video_call</span>
            </button>
            <button id="notifications-button" class="p-1.5 sm:p-2 rounded-full hover:bg-gray-100 focus:outline-none text-gray-700 relative hidden sm:inline-flex" title="الإشعارات">
                <span class="material-icons-outlined text-lg sm:text-xl">notifications</span>
                <span id="notification-badge" class="absolute top-0.5 right-0.5 sm:top-1 sm:right-1 bg-red-500 text-white text-[10px] w-3.5 h-3.5 sm:w-4 sm:h-4 rounded-full flex items-center justify-center hidden">0</span>
            </button>
            <div id="user-section" class="relative">
            </div>
            <div id="user-dropdown" class="hidden absolute top-16 left-0 mt-1 bg-white rounded-lg shadow-xl py-1 w-60 sm:w-72 z-[101] border border-gray-200">
                <a href="#" id="dropdown-user-profile-link" class="block px-3 py-2.5 sm:px-4 sm:py-3 border-b border-gray-200 hover:bg-gray-50">
                    <div class="flex items-center">
                        <img id="dropdown-user-avatar" src="https://via.placeholder.com/40" alt="User Avatar" class="h-9 w-9 sm:h-10 sm:w-10 rounded-full ml-2 sm:ml-3 object-cover border-2 border-red-200">
                        <div>
                            <p id="dropdown-user-name" class="text-xs sm:text-sm font-semibold text-gray-800">اسم المستخدم</p>
                            <p id="dropdown-user-email" class="text-[10px] sm:text-xs text-gray-500 truncate w-32 sm:w-40">email@example.com</p>
                            <p id="dropdown-user-points" class="text-[10px] sm:text-xs text-red-500 font-semibold mt-0.5">0 نقطة تفاعل</p>
                        </div>
                    </div>
                </a>
                <a href="#" id="your-channel-link" class="flex items-center px-3 py-2 sm:px-4 sm:py-2.5 text-xs sm:text-sm text-gray-700 hover:bg-gray-100"><span class="material-icons-outlined ml-2 sm:ml-3 text-gray-500 text-base sm:text-lg">account_box</span>قناتك</a>
                <a href="#" id="studio-link" class="flex items-center px-3 py-2 sm:px-4 sm:py-2.5 text-xs sm:text-sm text-gray-700 hover:bg-gray-100"><span class="material-icons-outlined ml-2 sm:ml-3 text-gray-500 text-base sm:text-lg">settings_input_antenna</span>استوديو Streamsy (البث)</a>
                <hr class="my-0.5 sm:my-1 border-gray-200">
                <a href="#" id="sign-out-button" class="flex items-center px-3 py-2 sm:px-4 sm:py-2.5 text-xs sm:text-sm text-gray-700 hover:bg-gray-100"><span class="material-icons-outlined ml-2 sm:ml-3 text-gray-500 text-base sm:text-lg">logout</span>تسجيل الخروج</a>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside id="sidebar" class="w-0 bg-white overflow-y-auto transition-all duration-300 ease-in-out fixed md:relative h-full md:h-auto z-50 transform translate-x-full md:translate-x-0 shadow-lg md:shadow-none border-r md:border-r-0 md:border-l border-gray-200 md:w-16 lg:w-64">
            <nav class="py-4 space-y-1">
                <a href="#" id="sidebar-home-button" class="sidebar-link flex items-center py-3 px-4 text-sm text-gray-700 hover:bg-gray-100 rounded-lg mx-2"><span class="material-icons-outlined ml-4">home</span><span class="">الرئيسية</span></a>
                <a href="#" id="sidebar-shorts-button" class="sidebar-link flex items-center py-3 px-4 text-sm text-gray-700 hover:bg-gray-100 rounded-lg mx-2"><span class="material-icons-outlined ml-4">smart_display</span><span class="">Shorts</span></a>
                <a href="#" id="sidebar-subscriptions-button" class="sidebar-link flex items-center py-3 px-4 text-sm text-gray-700 hover:bg-gray-100 rounded-lg mx-2"><span class="material-icons-outlined ml-4">subscriptions</span><span class="">الاشتراكات</span></a>
                <a href="#" id="sidebar-live-streams-button" class="sidebar-link flex items-center py-3 px-4 text-sm text-gray-700 hover:bg-gray-100 rounded-lg mx-2">
                    <span class="material-icons-outlined ml-4">sensors</span><span class="">البث المباشر</span>
                </a>
                <hr class="border-gray-200 my-2.5 mx-2">
                <a href="#" id="sidebar-your-channel-button" class="sidebar-link flex items-center py-3 px-4 text-sm text-gray-700 hover:bg-gray-100 rounded-lg mx-2"><span class="material-icons-outlined ml-4">person_outline</span><span class="">أنت</span></a>
                <a href="#" id="sidebar-history-button" class="sidebar-link flex items-center py-3 px-4 text-sm text-gray-700 hover:bg-gray-100 rounded-lg mx-2"><span class="material-icons-outlined ml-4">history</span><span class="">السجل</span></a>
                <a href="#" id="sidebar-liked-videos-button" class="sidebar-link flex items-center py-3 px-4 text-sm text-gray-700 hover:bg-gray-100 rounded-lg mx-2"><span class="material-icons-outlined ml-4">thumb_up</span><span class="">فيديوهات أعجبتني</span></a>
                <a href="#" id="sidebar-streams-button" class="sidebar-link flex items-center py-3 px-4 text-sm text-gray-700 hover:bg-gray-100 rounded-lg mx-2"><span class="material-icons-outlined ml-4">live_tv</span><span class="">بث مستمر (Streams)</span></a>
                <hr class="border-gray-200 my-2.5 mx-2">
                <div id="sidebar-explore-heading" class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase">استكشف</div>
                <a href="#" id="sidebar-trending-button" class="sidebar-link flex items-center py-3 px-4 text-sm text-gray-700 hover:bg-gray-100 rounded-lg mx-2"><span class="material-icons-outlined ml-4">local_fire_department</span><span class="">الأكثر رواجاً</span></a>

                <button id="open-upload-modal-button-sidebar" class="mt-4 w-full flex items-center py-3 px-4 text-sm text-gray-700 hover:bg-gray-100 rounded-lg mx-2 text-right"><span class="material-icons-outlined ml-4">file_upload</span><span class="">رفع فيديو</span></button>
            </nav>
        </aside>
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden" aria-hidden="true"></div>

        <div id="main-content-wrapper" class="flex-1 flex flex-col overflow-hidden">
            <div id="categories-bar-container" class="sticky top-0 bg-white py-2 sm:py-3 z-30 -mx-2 sm:-mx-4 md:-mx-6 px-2 sm:px-4 md:px-6 border-b border-gray-200 shadow-sm">
                 <div class="flex space-x-reverse space-x-2 sm:space-x-3 overflow-x-auto no-scrollbar pb-1">
                    <button data-category="all" class="category-button active text-xs sm:text-sm py-1.5 px-3 rounded-lg whitespace-nowrap focus:outline-none border">الكل</button>
                    <button data-category="originals" class="category-button text-xs sm:text-sm py-1.5 px-3 rounded-lg whitespace-nowrap focus:outline-none border"><span class="streamsy-gradient-text font-semibold">Streamsy Originals</span></button>
                    <button data-category="music" class="category-button text-xs sm:text-sm py-1.5 px-3 rounded-lg whitespace-nowrap focus:outline-none border">موسيقى</button>
                    <button data-category="gaming" class="category-button text-xs sm:text-sm py-1.5 px-3 rounded-lg whitespace-nowrap focus:outline-none border">ألعاب</button>
                    <button data-category="education" class="category-button text-xs sm:text-sm py-1.5 px-3 rounded-lg whitespace-nowrap focus:outline-none border">تعليم</button>
                 </div>
            </div>

            <section id="live-now-section" class="bg-red-50 p-3 sm:p-4 md:p-6 hidden">
                <div class="flex justify-between items-center mb-3 sm:mb-4">
                    <h2 class="text-lg sm:text-xl font-bold text-red-700 flex items-center">
                        <span class="material-icons-outlined mr-2 text-red-600">sensors</span> بث مباشر الآن
                    </h2>
                    <!-- <a href="#" id="view-all-live-streams-link" class="text-xs text-red-600 hover:underline hidden">مشاهدة الكل</a> -->
                </div>
                <div id="live-now-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-3 sm:gap-x-4 gap-y-5 sm:gap-y-6">
                </div>
                <p id="no-live-streams-message" class="text-center text-gray-500 py-4 hidden">لا يوجد بث مباشر حاليًا.</p>
            </section>

            <main id="video-grid-area" class="flex-1 bg-gray-50 p-2 sm:p-4 md:p-6 overflow-y-auto no-scrollbar">
                <div id="video-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-3 sm:gap-x-4 gap-y-6 sm:gap-y-8"> </div>
                <div id="loading-indicator" class="text-center py-8 text-gray-500 hidden"><span class="material-icons animate-spin text-4xl">refresh</span><p>جارٍ تحميل المزيد...</p></div>
                 <p id="no-videos-message" class="col-span-full text-center text-gray-500 mt-8 hidden text-lg">لا توجد فيديوهات لعرضها حالياً. <a href="#" id="upload-from-no-videos" class="text-red-500 hover:underline">كن أول من يرفع فيديو!</a></p>
                 <p id="search-no-results-message" class="col-span-full text-center text-gray-500 mt-8 hidden text-lg">لا توجد نتائج بحث تطابق "<span id="search-query-display"></span>".</p>
            </main>

            <div id="video-player-section" class="hidden flex-1 flex flex-col md:flex-row overflow-hidden bg-white">
                <div class="w-full md:flex-grow md:overflow-y-auto md:no-scrollbar">
                    <div class="max-w-full lg:max-w-5xl mx-auto">
                        <div class="aspect-video bg-black sticky top-0 md:top-0 z-20 shadow-xl relative">
                            <video id="current-video-player" class="video-js vjs-default-skin w-full h-full" controls autoplay muted playsinline></video>
                            <div id="autoplay-overlay" class="absolute inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center text-white p-4 z-30 hidden">
                                <p class="text-sm text-gray-300 mb-1">الفيديو التالي يبدأ خلال:</p>
                                <p id="autoplay-countdown" class="text-2xl font-bold mb-2">5</p>
                                <p id="autoplay-next-title" class="text-md font-semibold mb-3 line-clamp-2 text-center w-3/4">عنوان الفيديو التالي هنا</p>
                                <img id="autoplay-next-thumbnail" src="https://via.placeholder.com/120x68" alt="Next video thumbnail" class="w-32 h-auto rounded-md mb-4 shadow-lg">
                                <div class="flex space-x-reverse space-x-3">
                                    <button id="autoplay-cancel-button" class="autoplay-button bg-gray-600 hover:bg-gray-700">إلغاء</button>
                                    <button id="autoplay-play-now-button" class="autoplay-button bg-red-600 hover:bg-red-700">تشغيل الآن</button>
                                </div>
                            </div>
                        </div>
                        <div class="p-3 md:p-5">
                            <h1 id="current-video-title" class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-2">عنوان الفيديو هنا</h1>
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3 space-y-1.5 sm:space-y-0">
                                <div class="text-xs sm:text-sm text-gray-600"><span id="current-video-views">0 مشاهدة</span><span class="mx-1.5">•</span><span id="current-video-upload-date">تاريخ النشر</span></div>
                                <div class="flex items-center space-x-reverse space-x-1.5 sm:space-x-2">
                                    <button id="like-button" class="flex items-center text-gray-600 hover:text-blue-600 p-1.5 sm:p-2 rounded-lg hover:bg-gray-100 transition-colors"><span class="material-icons-outlined text-lg sm:text-xl">thumb_up</span><span id="likes-count" class="mr-1 text-xs font-medium">0</span></button>
                                    <button id="dislike-button" class="flex items-center text-gray-600 hover:text-red-700 p-1.5 sm:p-2 rounded-lg hover:bg-gray-100 transition-colors"><span class="material-icons-outlined text-lg sm:text-xl">thumb_down</span><span id="dislikes-count" class="mr-1 text-xs font-medium">0</span></button>
                                    <button id="share-button" class="flex items-center text-gray-600 hover:text-green-600 p-1.5 sm:p-2 rounded-lg hover:bg-gray-100 transition-colors"><span class="material-icons-outlined text-lg sm:text-xl">share</span><span class="mr-1 text-xs font-medium hidden sm:inline">مشاركة</span></button>
                                    <button id="save-button" class="flex items-center text-gray-600 hover:text-purple-600 p-1.5 sm:p-2 rounded-lg hover:bg-gray-100 transition-colors"><span class="material-icons-outlined text-lg sm:text-xl">playlist_add</span><span class="mr-1 text-xs font-medium hidden sm:inline">حفظ</span></button>
                                    <div id="quality-controls-wrapper" class="relative">
                                        <button id="quality-menu-button" class="flex items-center text-gray-600 hover:text-orange-600 p-1.5 sm:p-2 rounded-lg hover:bg-gray-100 transition-colors"><span class="material-icons-outlined text-lg sm:text-xl">settings</span></button>
                                        <div id="quality-options-dropdown" class="hidden absolute left-0 bottom-full mb-2 w-32 bg-white rounded-md shadow-lg border z-30 py-1"></div>
                                    </div>
                                    <button id="loop-video-button" class="player-control-button" title="تكرار الفيديو">
                                        <span class="material-icons-outlined text-lg sm:text-xl">loop</span>
                                    </button>
                                    <div id="more-video-options-wrapper" class="relative hidden">
                                        <button id="more-video-options-button" class="player-control-button" title="خيارات إضافية">
                                            <span class="material-icons-outlined text-lg sm:text-xl">more_vert</span>
                                        </button>
                                        <div id="video-options-dropdown" class="absolute left-0 bottom-full mb-2 w-48 bg-white rounded-md shadow-lg border z-30 py-1">
                                            <a href="#" id="edit-current-video-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 text-right"><span class="material-icons-outlined text-sm mr-2 align-middle">edit</span> تعديل الفيديو</a>
                                            <a href="#" id="delete-current-video-button" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 text-right"><span class="material-icons-outlined text-sm mr-2 align-middle">delete</span> حذف الفيديو</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <hr class="my-3 border-gray-200">
                            <div class="flex items-start sm:items-center justify-between mb-4 flex-col sm:flex-row space-y-2 sm:space-y-0">
                                <div class="flex items-center cursor-pointer" id="player-channel-info-clickable">
                                    <img id="current-video-channel-avatar" src="https://via.placeholder.com/48" alt="Channel Avatar" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full ml-3 object-cover border-2 border-gray-200">
                                    <div>
                                        <p id="current-video-channel-name" class="font-semibold text-gray-800 text-sm sm:text-md hover:text-red-600">اسم القناة</p>
                                        <p id="current-video-channel-subscribers" class="text-xs text-gray-500">0 مشترك</p>
                                    </div>
                                </div>
                                <button id="subscribe-button" data-channel-id="" class="bg-red-600 hover:bg-red-700 text-white text-xs sm:text-sm font-semibold py-2 px-4 sm:py-2.5 sm:px-6 rounded-full transition-colors w-full sm:w-auto shadow-md hover:shadow-lg">اشتراك</button>
                            </div>
                            <div id="description-container" class="bg-gray-50 p-3 rounded-lg mb-5 border border-gray-200 text-sm text-gray-700 hidden">
                                <p id="current-video-description-snippet" class="whitespace-pre-wrap line-clamp-3"></p>
                                <p id="current-video-description-full" class="whitespace-pre-wrap hidden"></p>
                                <button id="toggle-description-button" class="text-red-600 hover:underline text-xs font-semibold mt-1.5 hidden">عرض المزيد</button>
                            </div>

                            <div id="suggested-videos-mobile-container" class="md:hidden mb-5"></div>

                            <h3 class="text-md sm:text-lg font-semibold mb-3 text-gray-800">التعليقات (<span id="comments-count">0</span>)</h3>
                            <div id="comments-list" class="space-y-3 mb-5"></div>
                            <form id="add-comment-form" class="mb-5">
                                <textarea id="comment-text" rows="2" placeholder="إضافة تعليق عام..." required class="w-full p-2.5 border border-gray-300 rounded-md mb-2 focus:ring-red-500 focus:border-red-500 text-sm"></textarea>
                                <div class="text-left"><button type="submit" class="bg-red-600 text-white px-4 py-1.5 sm:px-5 sm:py-2 rounded-md hover:bg-red-700 font-semibold text-xs sm:text-sm shadow-md">تعليق</button></div>
                            </form>
                        </div>
                    </div>
                </div>
                <aside id="suggested-videos-aside" class="hidden md:block w-full md:w-2/5 lg:w-1/3 bg-gray-50 p-3 md:p-4 md:overflow-y-auto md:no-scrollbar border-l border-gray-200 shrink-0">
                </aside>
            </div>

            <div id="channel-page-section" class="hidden flex-1 overflow-y-auto no-scrollbar p-0">
                <div class="max-w-7xl mx-auto bg-gray-50">
                    <div><img id="channel-page-cover-photo" src="https://via.placeholder.com/1200x300?text=Cover+Photo" alt="Channel Cover Photo" class="channel-cover-photo"></div>
                    <div class="channel-header-card flex flex-col sm:flex-row items-center text-center sm:text-right px-3 md:px-5">
                        <img id="channel-page-avatar" src="https://via.placeholder.com/120" alt="Channel Avatar" class="w-24 h-24 sm:w-32 sm:h-32 rounded-full ml-0 sm:ml-6 mb-3 sm:mb-0 object-cover border-4 border-white shadow-lg">
                        <div class="flex-grow w-full">
                            <div class="flex flex-col sm:flex-row items-center sm:justify-between">
                                <h1 id="channel-page-name" class="text-xl md:text-2xl lg:text-3xl font-bold text-gray-800">اسم القناة</h1>
                                <button id="edit-channel-button" class="hidden mt-2 sm:mt-0 bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold py-1.5 px-3 rounded-md transition-colors flex items-center shadow"><span class="material-icons text-sm mr-1">edit</span> تعديل القناة</button>
                            </div>
                            <p id="channel-page-handle" class="text-xs sm:text-sm text-gray-500 mt-1">@channelhandle</p>
                            <div class="flex items-center justify-center sm:justify-start space-x-reverse space-x-2 mt-1 text-xs sm:text-sm text-gray-600">
                                <span id="channel-page-video-count">0 فيديوهات</span>
                                <span>•</span>
                                <span id="channel-page-subscriber-count">0 مشترك</span>
                                <span>•</span>
                                <span id="channel-page-points">0 نقطة تفاعل</span>
                            </div>
                            <p id="channel-page-description" class="text-xs sm:text-sm text-gray-700 mt-3 line-clamp-3 text-center sm:text-right">وصف القناة هنا.</p>
                        </div>
                         <button id="channel-page-subscribe-button" data-channel-id="" class="mt-4 sm:mt-0 sm:ml-auto bg-red-600 hover:bg-red-700 text-white text-sm font-semibold py-2 px-5 sm:py-2.5 sm:px-6 rounded-full transition-colors shrink-0 w-full sm:w-auto shadow-md hover:shadow-lg">اشتراك</button>
                    </div>
                    <div class="mt-8 px-3 md:px-6">
                        <h2 class="text-xl sm:text-2xl font-bold mb-5 sm:mb-7 text-gray-700 border-b-2 border-red-200 pb-2 sm:pb-3">فيديوهاتي</h2>
                        <div id="my-videos-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-3 sm:gap-x-4 gap-y-5 sm:gap-y-8"></div>
                        <p id="no-my-videos-message" class="hidden text-center text-gray-500 mt-8 py-6 text-md sm:text-lg">لم تقم برفع أي فيديوهات بعد. <a href="#" id="upload-from-channel-page" class="text-red-500 hover:underline">ابدأ برفع أول فيديو لك!</a></p>
                    </div>
                </div>
            </div>

            <main id="shorts-section" class="hidden flex-1 bg-gray-900 p-0 overflow-hidden">
                <div class="shorts-player-container relative">
                    <video id="shorts-video-player" class="shorts-video" loop playsinline>
                    </video>
                    <div class="shorts-ui-overlay p-3 sm:p-4">
                        <div class="flex justify-between items-start">
                            <button id="close-shorts-button" class="p-2 text-white opacity-80 hover:opacity-100"><span class="material-icons text-2xl sm:text-3xl">close</span></button>
                            <span class="font-bold text-md sm:text-lg">Shorts</span>
                        </div>
                        <div class="flex flex-col items-center space-y-4 sm:space-y-5">
                            <button class="flex flex-col items-center text-white"><span class="material-icons-outlined text-2xl sm:text-3xl">thumb_up</span><span class="text-xs">0</span></button>
                            <button class="flex flex-col items-center text-white"><span class="material-icons-outlined text-2xl sm:text-3xl">thumb_down</span><span class="text-xs">0</span></button>
                            <button class="flex flex-col items-center text-white"><span class="material-icons-outlined text-2xl sm:text-3xl">chat_bubble_outline</span><span class="text-xs">0</span></button>
                            <button class="flex flex-col items-center text-white"><span class="material-icons-outlined text-2xl sm:text-3xl">share</span></button>
                            <img src="https://via.placeholder.com/40" alt="Channel" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full border-2 border-white object-cover">
                        </div>
                    </div>
                    <button id="shorts-prev-button" class="absolute left-1 sm:left-2 top-1/2 -translate-y-1/2 p-1.5 sm:p-2 bg-black/30 rounded-full text-white hover:bg-black/50"><span class="material-icons text-xl sm:text-2xl">chevron_left</span></button>
                    <button id="shorts-next-button" class="absolute right-1 sm:right-2 top-1/2 -translate-y-1/2 p-1.5 sm:p-2 bg-black/30 rounded-full text-white hover:bg-black/50"><span class="material-icons text-xl sm:text-2xl">chevron_right</span></button>

                </div>
                <p class="text-center text-gray-400 py-3 text-xs sm:text-sm">ميزة Shorts قيد التطوير الكامل.</p>
            </main>

            <main id="subscriptions-section" class="hidden flex-1 bg-gray-50 p-2 sm:p-4 md:p-6 overflow-y-auto no-scrollbar">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6 text-gray-700">أحدث الفيديوهات من اشتراكاتك</h2>
                <div id="subscriptions-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-3 sm:gap-x-4 gap-y-6 sm:gap-y-8"></div>
                <p id="no-subscriptions-message" class="hidden text-center text-gray-500 mt-8 py-6 text-md sm:text-lg">لم تشترك في أي قنوات بعد، أو أن القنوات التي اشتركت بها لم ترفع فيديوهات جديدة.</p>
                <div id="loading-subscriptions-indicator" class="text-center py-8 text-gray-500 hidden"><span class="material-icons animate-spin text-4xl">refresh</span><p>جارٍ تحميل الاشتراكات...</p></div>
            </main>

            <main id="liked-videos-section" class="hidden flex-1 bg-gray-50 p-2 sm:p-4 md:p-6 overflow-y-auto no-scrollbar">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6 text-gray-700">فيديوهات أعجبتني</h2>
                <div id="liked-videos-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-3 sm:gap-x-4 gap-y-6 sm:gap-y-8"></div>
                <p id="no-liked-videos-message" class="hidden text-center text-gray-500 mt-8 py-6 text-md sm:text-lg">لم تعجب بأي فيديوهات بعد.</p>
                <div id="loading-liked-videos-indicator" class="text-center py-8 text-gray-500 hidden"><span class="material-icons animate-spin text-4xl">refresh</span><p>جارٍ تحميل الفيديوهات المعجب بها...</p></div>
            </main>

            <main id="history-section" class="hidden flex-1 bg-gray-50 p-2 sm:p-4 md:p-6 overflow-y-auto no-scrollbar">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6 text-gray-700">سجل المشاهدة</h2>
                <div id="history-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-3 sm:gap-x-4 gap-y-6 sm:gap-y-8"></div>
                <p id="no-history-message" class="hidden text-center text-gray-500 mt-8 py-6 text-md sm:text-lg">سجل المشاهدة فارغ.</p>
                <div id="loading-history-indicator" class="text-center py-8 text-gray-500 hidden"><span class="material-icons animate-spin text-4xl">refresh</span><p>جارٍ تحميل السجل...</p></div>
            </main>

            <main id="trending-section" class="hidden flex-1 bg-gray-50 p-2 sm:p-4 md:p-6 overflow-y-auto no-scrollbar">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6 text-gray-700">الأكثر رواجاً</h2>
                <div id="trending-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-3 sm:gap-x-4 gap-y-6 sm:gap-y-8"></div>
                <p id="no-trending-message" class="hidden text-center text-gray-500 mt-8 py-6 text-md sm:text-lg">لا توجد فيديوهات رائجة حالياً.</p>
                <div id="loading-trending-indicator" class="text-center py-8 text-gray-500 hidden"><span class="material-icons animate-spin text-4xl">refresh</span><p>جارٍ تحميل الفيديوهات الرائجة...</p></div>
            </main>

            <main id="streams-section" class="hidden flex-1 bg-gray-800 text-white p-0 overflow-hidden">
                <div class="flex h-full">
                    <div id="stream-player-area" class="flex-grow bg-black relative">
                         <video id="stream-video-player" class="w-full h-full" autoplay controls controlsList="nodownload"></video>
                         <div id="stream-info-overlay" class="absolute top-4 right-4 bg-black bg-opacity-60 p-3 rounded-lg shadow-lg hidden">
                            <h3 id="current-stream-name" class="text-lg font-semibold">اسم البث</h3>
                            <p id="current-stream-video-title" class="text-sm">اسم الفيديو الحالي</p>
                         </div>
                    </div>
                    <aside id="stream-playlist-sidebar" class="w-full md:w-1/3 lg:w-1/4 max-w-sm bg-gray-700 p-4 overflow-y-auto no-scrollbar shrink-0">
                        <h3 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">قوائم البث (Streams)</h3>
                        <div id="stream-playlist-items" class="space-y-2">
                        </div>
                         <p id="no-streams-available" class="text-center text-gray-400 mt-6">لا توجد قوائم بث متاحة حالياً.</p>
                         <button id="add-new-stream-playlist-button" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded-md text-sm font-medium flex items-center justify-center">
                            <span class="material-icons mr-2 text-lg">add_to_queue</span> إضافة قائمة بث جديدة
                         </button>
                    </aside>
                </div>
            </main>

        </div>
    </div>

    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[200] p-4 hidden">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-xl w-full max-w-sm sm:max-w-md relative">
            <button id="close-auth-modal" class="absolute top-3 left-3 sm:top-4 sm:left-4 text-gray-400 hover:text-gray-600"><span class="material-icons">close</span></button>
            <h2 id="auth-modal-title" class="text-xl sm:text-2xl font-bold text-gray-800 mb-6 sm:mb-7 text-center">تسجيل الدخول</h2>
            <form id="auth-form">
                <div class="mb-4 sm:mb-5"><label for="auth-email" class="block text-sm font-medium text-gray-700 mb-1 sm:mb-1.5">البريد الإلكتروني</label><input type="email" id="auth-email" required class="input-style" placeholder="example@mail.com"></div>
                <div class="mb-4 sm:mb-5"><label for="auth-password" class="block text-sm font-medium text-gray-700 mb-1 sm:mb-1.5">كلمة المرور</label><input type="password" id="auth-password" required class="input-style" placeholder="********"></div>
                <p id="auth-error" class="text-red-500 text-sm mb-4 sm:mb-5 text-center hidden"></p>
                <button type="submit" id="auth-submit-button" class="w-full bg-red-600 text-white py-2.5 sm:py-3 px-4 rounded-lg hover:bg-red-700 font-semibold shadow-md">تسجيل الدخول</button>
            </form>
            <p class="mt-6 sm:mt-7 text-center text-sm text-gray-600"><span id="auth-switch-text">ليس لديك حساب؟</span> <a href="#" id="auth-switch-button" class="font-medium text-red-600 hover:text-red-500">إنشاء حساب جديد</a></p>
        </div>
    </div>

    <div id="upload-video-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[200] p-2 sm:p-4 hidden overflow-y-auto">
        <div class="bg-white p-5 sm:p-8 rounded-xl shadow-2xl w-full max-w-md sm:max-w-2xl relative my-6 sm:my-8">
            <button id="close-upload-modal" class="absolute top-4 left-4 sm:top-5 sm:left-5 text-gray-400 hover:text-gray-600 transition-colors"><span class="material-icons text-xl sm:text-2xl">close</span></button>
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6 sm:mb-8 text-center border-b pb-4 sm:pb-5"><span class="material-icons mr-2 align-middle text-red-500">upload_file</span>رفع فيديو جديد</h2>
            <form id="upload-video-form" class="space-y-5 sm:space-y-6">
                <div><h3 class="text-md sm:text-lg font-semibold text-gray-700 mb-2">1. تفاصيل الفيديو</h3><div class="space-y-4 p-4 border border-gray-200 rounded-lg bg-gray-50"><div><label for="video-title" class="block text-sm font-medium text-gray-700 mb-1">عنوان الفيديو <span class="text-red-500">*</span></label><input type="text" id="video-title" required class="input-style text-sm" placeholder="أضف عنوانًا يصف الفيديو الخاص بك"></div><div><label for="video-description" class="block text-sm font-medium text-gray-700 mb-1">الوصف</label><textarea id="video-description" rows="3" class="input-style text-sm" placeholder="أخبر المشاهدين عن الفيديو الخاص بك..."></textarea></div><div><label for="video-category" class="block text-sm font-medium text-gray-700 mb-1">التصنيف</label><select id="video-category" class="input-style text-sm"><option value="">-- اختر تصنيف --</option><option value="ألعاب">ألعاب</option><option value="موسيقى">موسيقى</option><option value="تعليم">تعليم</option><option value="كوميديا">كوميديا</option><option value="مدونات فيديو">مدونات فيديو</option><option value="تقنية">تقنية</option><option value="أخبار وسياسة">أخبار وسياسة</option><option value="ترفيه">ترفيه</option><option value="رياضة">رياضة</option><option value="سفر">سفر وفعاليات</option><option value="حيوانات أليفة">حيوانات أليفة</option><option value="علوم وتكنولوجيا">علوم وتكنولوجيا</option><option value="أفلام ورسوم متحركة">أفلام ورسوم متحركة</option><option value="سيارات ومركبات">سيارات ومركبات</option><option value="منظمات غير ربحية ونشاط اجتماعي">منظمات غير ربحية ونشاط اجتماعي</option><option value="Streamsy Originals">Streamsy Originals</option></select></div><div><label for="video-tags" class="block text-sm font-medium text-gray-700 mb-1">الهاشتاجات (مفصولة بفاصلة)</label><input type="text" id="video-tags" class="input-style text-sm" placeholder="#مضحك, #لعبة_جديدة, #درس_مفيد"></div> <div class="flex items-center"><input type="checkbox" id="is-streamsy-original" class="ml-2 h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500"><label for="is-streamsy-original" class="text-sm font-medium text-gray-700">محتوى Streamsy Original؟</label></div></div></div>
                <div>
                    <h3 class="text-md sm:text-lg font-semibold text-gray-700 mb-2">2. ملفات الوسائط</h3>
                    <div class="space-y-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <div>
                            <label for="video-file" class="block text-sm font-medium text-gray-700 mb-1">ملف الفيديو <span class="text-red-500">*</span></label>
                            <input type="file" id="video-file" accept="video/*" required class="file-input-enhanced">
                            <p class="mt-1 text-xs text-gray-500">ملاحظة: لتوفير جودات متعددة، ستحتاج إلى معالجتها ورفعها بشكل منفصل لاحقًا (ميزة قيد التطوير).</p>
                        </div>
                        <div>
                            <label for="video-thumbnail" class="block text-sm font-medium text-gray-700 mb-1">صورة مصغرة (اختياري)</label>
                            <input type="file" id="video-thumbnail" accept="image/*" class="file-input-enhanced">
                            <p class="mt-1 text-xs text-gray-500">إذا لم يتم تحديد صورة، سيتم إنشاء واحدة تلقائيًا من الفيديو.</p>
                        </div>
                    </div>
                </div>
                <div id="upload-progress-bar-container" class="w-full bg-gray-200 rounded-full h-3 mb-4 hidden relative"><div id="upload-progress-bar" class="bg-gradient-to-r from-red-500 to-orange-500 h-3 rounded-full transition-all duration-300 ease-linear" style="width: 0%"></div><span id="upload-progress-text" class="absolute inset-0 flex items-center justify-center text-[10px] sm:text-xs font-medium text-white">0%</span></div>
                <p id="upload-status" class="text-xs sm:text-sm text-gray-600 mb-4 text-center"></p>
                <button type="submit" id="submit-upload-button" class="w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 font-semibold text-md sm:text-lg transition-colors flex items-center justify-center shadow-md"><span class="material-icons mr-2">cloud_upload</span>رفع الفيديو الآن</button>
            </form>
        </div>
    </div>

   <div id="edit-video-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[250] p-4 hidden">
       <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-lg">
           <h2 class="text-lg sm:text-xl font-bold mb-4 text-gray-800">تعديل الفيديو</h2>
           <form id="edit-video-form">
               <input type="hidden" id="edit-video-id">
               <div class="mb-3"><label for="edit-video-title" class="block text-sm font-medium text-gray-700">العنوان</label><input type="text" id="edit-video-title" required class="input-style mt-1 text-sm"></div>
               <div class="mb-3"><label for="edit-video-description" class="block text-sm font-medium text-gray-700">الوصف</label><textarea id="edit-video-description" rows="3" class="input-style mt-1 text-sm"></textarea></div>
               <div class="mb-3"><label for="edit-video-category" class="block text-sm font-medium text-gray-700">التصنيف</label><select id="edit-video-category" class="input-style mt-1 text-sm"><option value="">-- اختر تصنيف --</option><option value="ألعاب">ألعاب</option><option value="موسيقى">موسيقى</option><option value="تعليم">تعليم</option><option value="كوميديا">كوميديا</option><option value="مدونات فيديو">مدونات فيديو</option><option value="تقنية">تقنية</option><option value="أخبار وسياسة">أخبار وسياسة</option><option value="ترفيه">ترفيه</option><option value="رياضة">رياضة</option><option value="سفر">سفر وفعاليات</option><option value="حيوانات أليفة">حيوانات أليفة</option><option value="علوم وتكنولوجيا">علوم وتكنولوجيا</option><option value="أفلام ورسوم متحركة">أفلام ورسوم متحركة</option><option value="سيارات ومركبات">سيارات ومركبات</option><option value="منظمات غير ربحية ونشاط اجتماعي">منظمات غير ربحية ونشاط اجتماعي</option><option value="Streamsy Originals">Streamsy Originals</option></select></div>
               <div class="mb-4"><label for="edit-video-tags" class="block text-sm font-medium text-gray-700">الهاشتاجات (مفصولة بفاصلة)</label><input type="text" id="edit-video-tags" class="input-style mt-1 text-sm"></div>
                <div class="flex items-center mb-4"><input type="checkbox" id="edit-is-streamsy-original" class="ml-2 h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500"><label for="edit-is-streamsy-original" class="text-sm font-medium text-gray-700">محتوى Streamsy Original؟</label></div>
               <div class="flex justify-end space-x-reverse space-x-2 mt-4"><button type="button" id="close-edit-modal-button" class="px-4 py-1.5 text-sm bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700">إلغاء</button><button type="submit" class="px-4 py-1.5 text-sm bg-red-600 text-white rounded-md hover:bg-red-700 shadow-md">حفظ التعديلات</button></div>
           </form>
       </div>
   </div>

    <div id="edit-channel-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[260] p-2 sm:p-4 hidden overflow-y-auto">
        <div class="bg-white p-5 sm:p-8 rounded-xl shadow-2xl w-full max-w-md sm:max-w-xl relative my-6 sm:my-8">
            <button id="close-edit-channel-modal" class="absolute top-4 left-4 sm:top-5 sm:left-5 text-gray-400 hover:text-gray-600 transition-colors"><span class="material-icons text-xl sm:text-2xl">close</span></button>
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6 sm:mb-8 text-center border-b pb-4 sm:pb-5"><span class="material-icons mr-2 align-middle text-blue-500">edit_note</span>تعديل القناة</h2>
            <form id="edit-channel-form" class="space-y-5 sm:space-y-6">
                <div><label for="edit-channel-name" class="block text-sm font-medium text-gray-700 mb-1">اسم القناة <span class="text-red-500">*</span></label><input type="text" id="edit-channel-name" required class="input-style text-sm" placeholder="اسم قناتك المميز"></div>
                <div><label for="edit-channel-description" class="block text-sm font-medium text-gray-700 mb-1">وصف القناة</label><textarea id="edit-channel-description" rows="3" class="input-style text-sm" placeholder="أخبر المشاهدين عن قناتك..."></textarea></div>
                <div><label for="edit-channel-profile-picture" class="block text-sm font-medium text-gray-700 mb-1">الصورة الشخصية للقناة</label><input type="file" id="edit-channel-profile-picture" accept="image/*" class="file-input-enhanced"> <img id="edit-channel-profile-preview" src="" alt="Profile Preview" class="mt-2 h-20 w-20 sm:h-24 sm:w-24 rounded-full object-cover hidden border-2 border-gray-300"></div>
                <div><label for="edit-channel-cover-photo" class="block text-sm font-medium text-gray-700 mb-1">صورة الغلاف للقناة</label><input type="file" id="edit-channel-cover-photo" accept="image/*" class="file-input-enhanced"><img id="edit-channel-cover-preview" src="" alt="Cover Preview" class="mt-2 h-28 sm:h-36 w-full object-cover rounded-lg hidden border-2 border-gray-300"></div>
                <p id="edit-channel-status" class="text-xs sm:text-sm text-gray-600 mb-4 text-center"></p>
                <button type="submit" id="submit-edit-channel-button" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-semibold text-md sm:text-lg transition-colors flex items-center justify-center shadow-md"><span class="material-icons mr-2">save</span>حفظ التغييرات</button>
            </form>
        </div>
    </div>
    <div id="studio-info-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[270] p-4 hidden">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-xl w-full max-w-2xl relative"> <!-- Increased max-width -->
            <button id="close-studio-info-modal" class="absolute top-3 left-3 sm:top-4 sm:left-4 text-gray-400 hover:text-gray-600"><span class="material-icons">close</span></button>
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-5 text-center">استوديو البث </h2>

            <div id="live-stream-login-prompt" class="text-center py-6 hidden">
                <p class="text-gray-600 mb-3 text-md">يجب تسجيل الدخول للوصول إلى إعدادات البث.</p>
                <button id="login-for-stream-button" class="bg-red-500 text-white px-8 py-2.5 rounded-md hover:bg-red-600 font-semibold">تسجيل الدخول</button>
            </div>

            <div id="live-stream-setup-info" class="text-sm text-gray-700 space-y-4 mb-6 hidden">
                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">إعدادات البث (OBS أو ما شابه):</h3>
                <div>
                    <label class="block text-xs font-medium text-gray-500">عنوان خادم RTMP:</label>
                    <input type="text" id="rtmp-server-url" readonly class="input-style text-xs bg-gray-100 cursor-text p-2 mt-1">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500">مفتاح البث (Stream Key):</label>
                    <input type="text" id="stream-key-display" readonly class="input-style text-xs bg-gray-100 cursor-text p-2 mt-1">
                </div>
                <p class="text-xs text-gray-500">استخدم هذه المعلومات في برنامج البث الخاص بك (مثل OBS). تأكد من أن خادم Ant Media الخاص بك يعمل.</p>
            </div>

            <div id="live-stream-controls" class="text-sm text-gray-700 space-y-4 mb-4 hidden">
                 <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">إدارة البث:</h3>
                 <div>
                    <label for="live-stream-title" class="block text-sm font-medium text-gray-700 mb-1">عنوان البث الحالي:</label>
                    <input type="text" id="live-stream-title" class="input-style text-sm" placeholder="اكتب عنوانًا جذابًا لبثك...">
                </div>
                <button id="start-live-stream-button" class="w-full bg-green-600 text-white py-2.5 px-4 rounded-lg hover:bg-green-700 font-semibold flex items-center justify-center">
                    <span class="material-icons-outlined mr-2">play_circle_filled</span> بدء/تحديث معلومات البث
                </button>
                <button id="stop-live-stream-button" class="w-full bg-red-600 text-white py-2.5 px-4 rounded-lg hover:bg-red-700 font-semibold flex items-center justify-center hidden">
                    <span class="material-icons-outlined mr-2">stop_circle</span> إيقاف البث المباشر
                </button>
                <p id="live-stream-status" class="text-xs text-center text-gray-600"></p>
            </div>

            <p class="text-xs text-gray-500 mt-6 text-center">يمكنك أيضًا استخدام ميزة <a href="#" id="go-to-streams-from-modal" class="text-red-500 hover:underline">"بث مستمر (Streams)"</a> لإنشاء قوائم تشغيل تعمل تلقائيًا.</p>
            <button id="ok-studio-info-modal" class="mt-6 w-full bg-gray-700 text-white py-2.5 px-4 rounded-lg hover:bg-gray-800 font-semibold">إغلاق</button>
        </div>
    </div>

    <div id="add-stream-playlist-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[280] p-4 hidden overflow-y-auto">
        <div class="bg-white p-5 sm:p-8 rounded-xl shadow-2xl w-full max-w-lg relative my-8">
            <button id="close-add-stream-playlist-modal" class="absolute top-4 left-4 text-gray-400 hover:text-gray-600">
                <span class="material-icons">close</span>
            </button>
            <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">إنشاء/تعديل قائمة بث (Stream)</h2>
            <form id="add-stream-playlist-form" class="space-y-4">
                <div>
                    <label for="stream-playlist-name" class="block text-sm font-medium text-gray-700 mb-1">اسم قائمة البث</label>
                    <input type="text" id="stream-playlist-name" required class="input-style text-sm" placeholder="مثال: بث الألعاب اليومي">
                </div>
                <div>
                    <label for="stream-playlist-video-ids" class="block text-sm font-medium text-gray-700 mb-1">معرفات الفيديوهات (مفصولة بفاصلة)</label>
                    <textarea id="stream-playlist-video-ids" rows="3" class="input-style text-sm" placeholder="الصق معرفات الفيديوهات هنا, مثل: videoId1,videoId2,videoId3"></textarea>
                    <p class="text-xs text-gray-500 mt-1">يمكنك الحصول على معرف الفيديو من الرابط عند مشاهدته.</p>
                </div>
                 <input type="hidden" id="editing-stream-playlist-id">
                <button type="submit" id="submit-add-stream-playlist-button" class="w-full bg-green-600 text-white py-2.5 px-4 rounded-lg hover:bg-green-700 font-semibold">
                    حفظ قائمة البث
                </button>
            </form>
        </div>
    </div>


    <script>
       const firebaseConfig = {
            apiKey: "AIzaSyDBpYxSx0MYQ6c_RRSOLvqEEWkKOMq5Zg0",
            authDomain: "sign-b2acd.firebaseapp.com",
            projectId: "sign-b2acd",
            storageBucket: "sign-b2acd.appspot.com",
            messagingSenderId: "1039449385751",
            appId: "1:1039449385751:web:e63d9b04d5698595922552"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        console.log("Streamsy Firebase Initialized (Enhanced - V5 Live Stream Ready)");

        // --- IMPORTANT: REPLACE WITH YOUR ANT MEDIA SERVER IP/DOMAIN ---
        const YOUR_SERVER_IP = "YOUR_ANT_MEDIA_SERVER_IP"; // e.g., "123.45.67.89" or "live.yourdomain.com"
        const LIVE_APP_NAME = "LiveApp"; // Default Ant Media Server application name
        // ---

        let currentVideoIdForPlayer = null;
        let currentChannelIdForPlayer = null;
        let unsubscribeCommentsListener = null;
        let unsubscribeVideoListener = null;
        let unsubscribeSubscriptionsListener = null;
        let allVideosDataCache = [];
        let suggestedVideosCache = [];
        let previousSidebarState = null;
        let currentVideoDataForPlayer = null;
        let isPlayerDescriptionExpanded = false;
        let currentChannelOwnerIdForPage = null;
        const INTERACTION_POINTS = { LIKE: 2, COMMENT: 3, SUBSCRIBE: 5, UPLOAD_VIDEO: 10, WATCH_VIDEO: 1 };

        let autoplayTimer = null;
        let autoplayCountdownValue = 5;
        const AUTOPLAY_DEFAULT_COUNTDOWN = 5;
        let nextAutoplayVideoId = null;
        let isAutoplayCancelledManually = false;

        let currentStreamPlaylist = [];
        let currentStreamVideoIndex = 0;
        let currentSelectedStreamId = null;
        let videoJsPlayer = null;


        const bodyElement = document.body;
        const logoHomeButton = document.getElementById('logo-home-button');
        const menuButton = document.getElementById('menu-button');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const searchInput = document.getElementById('search-input');
        const userSection = document.getElementById('user-section');
        const userDropdown = document.getElementById('user-dropdown');
        const dropdownUserProfileLink = document.getElementById('dropdown-user-profile-link');
        const dropdownUserAvatar = document.getElementById('dropdown-user-avatar');
        const dropdownUserName = document.getElementById('dropdown-user-name');
        const dropdownUserEmail = document.getElementById('dropdown-user-email');
        const dropdownUserPoints = document.getElementById('dropdown-user-points');
        const signOutButton = document.getElementById('sign-out-button');
        const studioLink = document.getElementById('studio-link');
        const notificationsButton = document.getElementById('notifications-button');
        const notificationBadge = document.getElementById('notification-badge');
        const videoGridArea = document.getElementById('video-grid-area');
        const videoPlayerSection = document.getElementById('video-player-section');
        const channelPageSection = document.getElementById('channel-page-section');
        const shortsSection = document.getElementById('shorts-section');
        const subscriptionsSection = document.getElementById('subscriptions-section');
        const likedVideosSection = document.getElementById('liked-videos-section');
        const historySection = document.getElementById('history-section');
        const trendingSection = document.getElementById('trending-section');
        const streamsSection = document.getElementById('streams-section');
        const liveNowSection = document.getElementById('live-now-section');


        const categoriesBar = document.getElementById('categories-bar-container');
        const videoGrid = document.getElementById('video-grid');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noVideosMessage = document.getElementById('no-videos-message');
        const uploadFromNoVideosLink = document.getElementById('upload-from-no-videos');
        const searchNoResultsMessage = document.getElementById('search-no-results-message');
        const searchQueryDisplay = document.getElementById('search-query-display');

        const currentPlayer = document.getElementById('current-video-player');
        const playerTitle = document.getElementById('current-video-title');
        const playerViews = document.getElementById('current-video-views');
        const playerUploadDateElem = document.getElementById('current-video-upload-date');
        const playerChannelAvatar = document.getElementById('current-video-channel-avatar');
        const playerChannelName = document.getElementById('current-video-channel-name');
        const playerChannelSubscribers = document.getElementById('current-video-channel-subscribers');
        const playerChannelInfoClickable = document.getElementById('player-channel-info-clickable');
        const playerSubscribeButton = document.getElementById('subscribe-button');
        const playerLikeButton = document.getElementById('like-button');
        const playerLikesCountSpan = document.getElementById('likes-count');
        const playerDislikeButton = document.getElementById('dislike-button');
        const playerDislikesCountSpan = document.getElementById('dislikes-count');
        const playerShareButton = document.getElementById('share-button');
        const playerSaveButton = document.getElementById('save-button');
        const qualityControlsWrapper = document.getElementById('quality-controls-wrapper');
        const qualityMenuButton = document.getElementById('quality-menu-button');
        const qualityOptionsDropdown = document.getElementById('quality-options-dropdown');
        const loopVideoButton = document.getElementById('loop-video-button');
        const moreVideoOptionsWrapper = document.getElementById('more-video-options-wrapper');
        const moreVideoOptionsButton = document.getElementById('more-video-options-button');
        const videoOptionsDropdown = document.getElementById('video-options-dropdown');
        const editCurrentVideoButton = document.getElementById('edit-current-video-button');
        const deleteCurrentVideoButton = document.getElementById('delete-current-video-button');

        const playerDescriptionContainer = document.getElementById('description-container');
        const playerDescriptionSnippet = document.getElementById('current-video-description-snippet');
        const playerDescriptionFull = document.getElementById('current-video-description-full');
        const playerToggleDescriptionButton = document.getElementById('toggle-description-button');
        const playerCommentsList = document.getElementById('comments-list');
        const playerCommentsCountSpan = document.getElementById('comments-count');
        const playerAddCommentForm = document.getElementById('add-comment-form');
        const playerCommentTextInput = document.getElementById('comment-text');
        const suggestedVideosAside = document.getElementById('suggested-videos-aside');
        const suggestedVideosMobileContainer = document.getElementById('suggested-videos-mobile-container');

        const autoplayOverlay = document.getElementById('autoplay-overlay');
        const autoplayCountdown = document.getElementById('autoplay-countdown');
        const autoplayNextTitle = document.getElementById('autoplay-next-title');
        const autoplayNextThumbnail = document.getElementById('autoplay-next-thumbnail');
        const autoplayCancelButton = document.getElementById('autoplay-cancel-button');
        const autoplayPlayNowButton = document.getElementById('autoplay-play-now-button');

        const channelPageCoverPhoto = document.getElementById('channel-page-cover-photo');
        const channelPageAvatar = document.getElementById('channel-page-avatar');
        const channelPageName = document.getElementById('channel-page-name');
        const channelPageHandle = document.getElementById('channel-page-handle');
        const channelPageVideoCount = document.getElementById('channel-page-video-count');
        const channelPageSubscriberCount = document.getElementById('channel-page-subscriber-count');
        const channelPagePoints = document.getElementById('channel-page-points');
        const channelPageDescription = document.getElementById('channel-page-description');
        const editChannelButton = document.getElementById('edit-channel-button');
        const channelPageSubscribeButton = document.getElementById('channel-page-subscribe-button');
        const myVideosGrid = document.getElementById('my-videos-grid');
        const noMyVideosMessageEl = document.getElementById('no-my-videos-message');
        const uploadFromChannelPageLink = document.getElementById('upload-from-channel-page');
        const shortsVideoPlayer = document.getElementById('shorts-video-player');
        const closeShortsButton = document.getElementById('close-shorts-button');
        const subscriptionsGrid = document.getElementById('subscriptions-grid');
        const noSubscriptionsMessage = document.getElementById('no-subscriptions-message');
        const loadingSubscriptionsIndicator = document.getElementById('loading-subscriptions-indicator');

        const likedVideosGrid = document.getElementById('liked-videos-grid');
        const noLikedVideosMessage = document.getElementById('no-liked-videos-message');
        const loadingLikedVideosIndicator = document.getElementById('loading-liked-videos-indicator');

        const historyGrid = document.getElementById('history-grid');
        const noHistoryMessage = document.getElementById('no-history-message');
        const loadingHistoryIndicator = document.getElementById('loading-history-indicator');

        const trendingGrid = document.getElementById('trending-grid');
        const noTrendingMessage = document.getElementById('no-trending-message');
        const loadingTrendingIndicator = document.getElementById('loading-trending-indicator');

        const streamPlayerArea = document.getElementById('stream-player-area');
        const streamVideoPlayer = document.getElementById('stream-video-player');
        const streamInfoOverlay = document.getElementById('stream-info-overlay');
        const currentStreamNameElem = document.getElementById('current-stream-name');
        const currentStreamVideoTitleElem = document.getElementById('current-stream-video-title');
        const streamPlaylistSidebar = document.getElementById('stream-playlist-sidebar');
        const streamPlaylistItems = document.getElementById('stream-playlist-items');
        const noStreamsAvailable = document.getElementById('no-streams-available');
        const addNewStreamPlaylistButton = document.getElementById('add-new-stream-playlist-button');
        const addStreamPlaylistModal = document.getElementById('add-stream-playlist-modal');
        const closeAddStreamPlaylistModalButton = document.getElementById('close-add-stream-playlist-modal');
        const addStreamPlaylistForm = document.getElementById('add-stream-playlist-form');
        const streamPlaylistNameInput = document.getElementById('stream-playlist-name');
        const streamPlaylistVideoIdsInput = document.getElementById('stream-playlist-video-ids');
        const editingStreamPlaylistIdInput = document.getElementById('editing-stream-playlist-id');
        const submitAddStreamPlaylistButton = document.getElementById('submit-add-stream-playlist-button');

        const liveNowGrid = document.getElementById('live-now-grid');
        const noLiveStreamsMessage = document.getElementById('no-live-streams-message');
        const sidebarLiveStreamsButton = document.getElementById('sidebar-live-streams-button');
        const rtmpServerUrlInput = document.getElementById('rtmp-server-url');
        const streamKeyDisplayInput = document.getElementById('stream-key-display');
        const liveStreamTitleInput = document.getElementById('live-stream-title');
        const startLiveStreamButton = document.getElementById('start-live-stream-button');
        const stopLiveStreamButton = document.getElementById('stop-live-stream-button');
        const liveStreamStatus = document.getElementById('live-stream-status');
        const liveStreamSetupInfo = document.getElementById('live-stream-setup-info');
        const liveStreamControls = document.getElementById('live-stream-controls');
        const liveStreamLoginPrompt = document.getElementById('live-stream-login-prompt');
        const loginForStreamButton = document.getElementById('login-for-stream-button');



        const authModal = document.getElementById('auth-modal');
        const closeAuthModalButton = document.getElementById('close-auth-modal');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authError = document.getElementById('auth-error');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authSubmitButton = document.getElementById('auth-submit-button');
        const authSwitchText = document.getElementById('auth-switch-text');
        const authSwitchButton = document.getElementById('auth-switch-button');
        let isLoginMode = true;
        const openUploadModalButtonHeader = document.getElementById('open-upload-modal-button-header');
        const openUploadModalButtonSidebar = document.getElementById('open-upload-modal-button-sidebar');
        const uploadVideoModal = document.getElementById('upload-video-modal');
        const closeUploadModalBtn = document.getElementById('close-upload-modal');
        const uploadVideoForm = document.getElementById('upload-video-form');
        const videoTitleInput = document.getElementById('video-title');
        const videoDescriptionInput = document.getElementById('video-description');
        const videoCategoryInput = document.getElementById('video-category');
        const videoTagsInput = document.getElementById('video-tags');
        const isStreamsyOriginalCheckbox = document.getElementById('is-streamsy-original');
        const videoFileInput = document.getElementById('video-file');
        const thumbnailFileInput = document.getElementById('video-thumbnail');
        const uploadProgressBarContainer = document.getElementById('upload-progress-bar-container');
        const uploadProgressBar = document.getElementById('upload-progress-bar');
        const uploadProgressText = document.getElementById('upload-progress-text');
        const uploadStatus = document.getElementById('upload-status');
        const submitUploadButton = document.getElementById('submit-upload-button');
        const editVideoModal = document.getElementById('edit-video-modal');
        const closeEditModalButton = document.getElementById('close-edit-modal-button');
        const editVideoForm = document.getElementById('edit-video-form');
        const editVideoIdInput = document.getElementById('edit-video-id');
        const editVideoTitleInput = document.getElementById('edit-video-title');
        const editVideoDescriptionInput = document.getElementById('edit-video-description');
        const editVideoCategoryInput = document.getElementById('edit-video-category');
        const editVideoTagsInput = document.getElementById('edit-video-tags');
        const editIsStreamsyOriginalCheckbox = document.getElementById('edit-is-streamsy-original');
        const editChannelModal = document.getElementById('edit-channel-modal');
        const closeEditChannelModalButton = document.getElementById('close-edit-channel-modal');
        const editChannelForm = document.getElementById('edit-channel-form');
        const editChannelNameInput = document.getElementById('edit-channel-name');
        const editChannelDescriptionInput = document.getElementById('edit-channel-description');
        const editChannelProfilePictureInput = document.getElementById('edit-channel-profile-picture');
        const editChannelProfilePreview = document.getElementById('edit-channel-profile-preview');
        const editChannelCoverPhotoInput = document.getElementById('edit-channel-cover-photo');
        const editChannelCoverPreview = document.getElementById('edit-channel-cover-preview');
        const editChannelStatus = document.getElementById('edit-channel-status');
        const submitEditChannelButton = document.getElementById('submit-edit-channel-button');
        const sidebarHomeButton = document.getElementById('sidebar-home-button');
        const sidebarShortsButton = document.getElementById('sidebar-shorts-button');
        const sidebarSubscriptionsButton = document.getElementById('sidebar-subscriptions-button');
        const sidebarYourChannelButton = document.getElementById('sidebar-your-channel-button');
        const yourChannelLink = document.getElementById('your-channel-link');
        const sidebarExploreHeading = document.getElementById('sidebar-explore-heading');

        const sidebarHistoryButton = document.getElementById('sidebar-history-button');
        const sidebarLikedVideosButton = document.getElementById('sidebar-liked-videos-button');
        const sidebarTrendingButton = document.getElementById('sidebar-trending-button');
        const sidebarStreamsButton = document.getElementById('sidebar-streams-button');

        const studioInfoModal = document.getElementById('studio-info-modal');
        const closeStudioInfoModalButton = document.getElementById('close-studio-info-modal');
        const okStudioInfoModalButton = document.getElementById('ok-studio-info-modal');
        const startScreenShareButton = document.getElementById('start-screen-share-button');
        const screenSharePreview = document.getElementById('screen-share-preview');
        const goToStreamsFromModalLink = document.getElementById('go-to-streams-from-modal');



        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        async function updateUserInteractionPoints(userId, points) {
            if (!userId || !points) return;
            const userRef = db.collection('users').doc(userId);
            try {
                await userRef.update({
                    interactionPoints: firebase.firestore.FieldValue.increment(points)
                });
                console.log(`User ${userId} points updated by ${points}`);
                if (auth.currentUser && auth.currentUser.uid === userId) {
                    const updatedUserDoc = await userRef.get();
                    if (updatedUserDoc.exists) {
                        if(dropdownUserPoints) dropdownUserPoints.textContent = `${updatedUserDoc.data().interactionPoints || 0} نقطة تفاعل`;
                    }
                }
            } catch (error) {
                if (error.code === 'not-found' || (error.message && error.message.includes("No document to update"))) {
                    try {
                        await userRef.set({ interactionPoints: points }, { merge: true });
                        console.log(`User ${userId} points initialized to ${points}`);
                        if (auth.currentUser && auth.currentUser.uid === userId) {
                             if(dropdownUserPoints) dropdownUserPoints.textContent = `${points} نقطة تفاعل`;
                        }
                    } catch (setEror) {
                         console.warn(`Failed to initialize points for user ${userId}:`, setEror);
                    }
                } else {
                    console.warn(`Failed to update points for user ${userId}:`, error);
                }
            }
        }

        function updateActiveSidebarLink(activeButtonId) {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('sidebar-link-active');
                const icon = link.querySelector('.material-icons, .material-icons-outlined');
                if (icon) {
                    if (!icon.classList.contains('material-icons-outlined')) {
                         icon.classList.remove('material-icons');
                         icon.classList.add('material-icons-outlined');
                    }
                    icon.style.fontVariationSettings = '';
                }
            });
            const activeButton = document.getElementById(activeButtonId);
            if (activeButton) {
                activeButton.classList.add('sidebar-link-active');
                 const icon = activeButton.querySelector('.material-icons, .material-icons-outlined');
                 if(icon) {
                    if (icon.classList.contains('material-icons-outlined')) {
                        icon.classList.remove('material-icons-outlined');
                        icon.classList.add('material-icons');
                    }
                    icon.style.fontVariationSettings = "FILL 1, wght 700, GRAD 0, opsz 48";
                 }
            }
        }

        function hideAllMainSections() {
            if(videoGridArea) videoGridArea.classList.add('hidden');
            if(videoPlayerSection) videoPlayerSection.classList.add('hidden');
            if(channelPageSection) channelPageSection.classList.add('hidden');
            if(shortsSection) shortsSection.classList.add('hidden');
            if(subscriptionsSection) subscriptionsSection.classList.add('hidden');
            if(likedVideosSection) likedVideosSection.classList.add('hidden');
            if(historySection) historySection.classList.add('hidden');
            if(trendingSection) trendingSection.classList.add('hidden');
            if(streamsSection) streamsSection.classList.add('hidden');
            if(liveNowSection) liveNowSection.classList.add('hidden');

            if(categoriesBar) categoriesBar.classList.add('hidden');
            if (suggestedVideosAside) suggestedVideosAside.classList.add('hidden');
            if(suggestedVideosMobileContainer) suggestedVideosMobileContainer.classList.add('hidden');
            if(noVideosMessage) noVideosMessage.classList.add('hidden');
            if(searchNoResultsMessage) searchNoResultsMessage.classList.add('hidden');
            if (unsubscribeSubscriptionsListener) { unsubscribeSubscriptionsListener(); unsubscribeSubscriptionsListener = null; }
            if (autoplayTimer) { clearTimeout(autoplayTimer); autoplayTimer = null; }
            if (autoplayOverlay) autoplayOverlay.classList.add('hidden');

            if(streamVideoPlayer && !streamVideoPlayer.paused) {
                streamVideoPlayer.pause();
                streamVideoPlayer.src = "";
                currentStreamPlaylist = [];
                currentStreamVideoIndex = 0;
            }
            if (screenSharePreview && screenSharePreview.srcObject) {
                screenSharePreview.srcObject.getTracks().forEach(track => track.stop());
                screenSharePreview.srcObject = null;
                screenSharePreview.classList.add('hidden');
            }
        }

        function navigateToHomeView(isSearch = false, fromOtherPage = false) {
            hideAllMainSections();
            if(liveNowSection && liveNowGrid && liveNowGrid.children.length > 0) liveNowSection.classList.remove('hidden'); // Show live section if there are live streams
            if(videoGridArea) videoGridArea.classList.remove('hidden');
            if(categoriesBar) categoriesBar.classList.remove('hidden');
            currentVideoIdForPlayer = null;
            currentChannelIdForPlayer = null;
            isAutoplayCancelledManually = false;
            if (unsubscribeCommentsListener) { unsubscribeCommentsListener(); unsubscribeCommentsListener = null; }
            if (unsubscribeVideoListener) { unsubscribeVideoListener(); unsubscribeVideoListener = null; }

            if (videoJsPlayer) { // Dispose Video.js player if navigating away from player
                videoJsPlayer.dispose();
                videoJsPlayer = null;
                 // Recreate the original video tag for HTML5 player
                const videoContainer = currentPlayer.parentElement;
                if (videoContainer) {
                    const newPlayer = document.createElement('video');
                    newPlayer.id = "current-video-player";
                    newPlayer.className = "w-full h-full"; // Keep original classes
                    newPlayer.controls = true;
                    newPlayer.setAttribute('controlsList', 'nodownload');
                    videoContainer.innerHTML = ''; // Clear Video.js remnants
                    videoContainer.appendChild(newPlayer);
                    // Re-assign currentPlayer to the new element - important!
                    // This needs to be handled carefully if currentPlayer is used directly elsewhere before re-initialization
                }
            } else if (currentPlayer) {
                 currentPlayer.pause();
                 currentPlayer.src = "";
            }


            if (!isSearch) {
                 document.body.scrollTop = 0; document.documentElement.scrollTop = 0;
            }
            updateActiveSidebarLink('sidebar-home-button');

            const isMobile = window.innerWidth < 768;
            if (isMobile) {
                if (sidebar && !sidebar.classList.contains('translate-x-full')) {
                    toggleSidebar();
                }
            } else {
                if (previousSidebarState && sidebar) {
                    sidebar.classList.remove('w-0', 'lg:w-64', 'md:w-16', 'md:w-64', 'lg:w-16', 'translate-x-full', 'md:translate-x-0');
                    previousSidebarState.classes.forEach(cls => sidebar.classList.add(cls));

                    const isLgFullRestored = sidebar.classList.contains('lg:w-64');
                    sidebar.querySelectorAll('span').forEach(span => {
                        const isLgInlineSpan = span.classList.contains('lg:inline');
                        if (isLgInlineSpan) span.classList.toggle('lg:inline', isLgFullRestored);
                        else span.classList.toggle('md:hidden', !isLgFullRestored && !sidebar.classList.contains('md:w-64'));
                    });
                    sidebar.querySelectorAll('.sidebar-link .material-icons, .sidebar-link .material-icons-outlined').forEach(icon => {
                        icon.classList.toggle('lg:ml-4', isLgFullRestored);
                        icon.classList.toggle('ml-0', !isLgFullRestored);
                    });
                     if (sidebarExploreHeading) sidebarExploreHeading.classList.toggle('hidden', !isLgFullRestored && !sidebar.classList.contains('md:w-64'));


                    if (sidebarOverlay) {
                        sidebarOverlay.classList.toggle('hidden', previousSidebarState.overlayHidden);
                    }
                    previousSidebarState = null;
                }
            }
            if (!isSearch && categoriesBar) {
                filterVideosByCategory(categoriesBar.querySelector('.category-button.active')?.dataset.category || 'all');
            }
        }

        function toggleSidebar() {
            if (!sidebar) return;
            const isMobile = window.innerWidth < 768;

            if (isMobile) {
                const isOpen = !sidebar.classList.contains('translate-x-full');
                sidebar.classList.toggle('translate-x-full');
                sidebar.classList.toggle('w-64', !isOpen);
                sidebar.classList.toggle('w-0', isOpen);
                if (sidebarOverlay) sidebarOverlay.classList.toggle('hidden');
                bodyElement.classList.toggle('body-no-scroll', !isOpen);

                sidebar.querySelectorAll('span').forEach(s => s.classList.remove('md:hidden', 'lg:hidden'));
                sidebar.querySelectorAll('.sidebar-link .material-icons, .sidebar-link .material-icons-outlined').forEach(icon => icon.classList.add('ml-4'));
                if (sidebarExploreHeading) sidebarExploreHeading.classList.remove('hidden');


            } else {
                const isLg = window.innerWidth >= 1024;
                const isCurrentlyLgCollapsed = sidebar.classList.contains('lg:w-16');
                const isCurrentlyMdCollapsed = sidebar.classList.contains('md:w-16') && !isLg;

                let toBecomeExpanded;
                if (isLg) {
                    toBecomeExpanded = isCurrentlyLgCollapsed;
                    sidebar.classList.toggle('lg:w-16', !toBecomeExpanded);
                    sidebar.classList.toggle('lg:w-64', toBecomeExpanded);
                } else {
                    toBecomeExpanded = isCurrentlyMdCollapsed;
                    sidebar.classList.toggle('md:w-16', !toBecomeExpanded);
                    sidebar.classList.toggle('md:w-64', toBecomeExpanded);
                }

                if (isLg) {
                    sidebar.classList.toggle('md:w-16', !toBecomeExpanded);
                    sidebar.classList.toggle('md:w-64', toBecomeExpanded);
                } else {
                    sidebar.classList.toggle('lg:w-16', !toBecomeExpanded);
                    sidebar.classList.toggle('lg:w-64', toBecomeExpanded);
                }

                const isNowExpanded = sidebar.classList.contains('lg:w-64') || sidebar.classList.contains('md:w-64');
                sidebar.querySelectorAll('span').forEach(span => {
                    if (span.classList.contains('lg:inline')) {
                         span.classList.toggle('lg:inline', sidebar.classList.contains('lg:w-64'));
                    } else {
                         span.classList.toggle('md:hidden', !isNowExpanded);
                    }
                });
                 sidebar.querySelectorAll('.sidebar-link .material-icons, .sidebar-link .material-icons-outlined').forEach(icon => {
                    icon.classList.toggle('ml-4', isNowExpanded);
                    icon.classList.toggle('ml-0', !isNowExpanded);
                });
                if(sidebarExploreHeading) sidebarExploreHeading.classList.toggle('hidden', !isNowExpanded);
            }
        }

        function setInitialSidebarTextState() {
            const isMobile = window.innerWidth < 768;
            if (isMobile || !sidebar) return;

            const isLg = window.innerWidth >= 1024;
            let isInitiallyExpanded;

            if (isLg) isInitiallyExpanded = sidebar.classList.contains('lg:w-64');
            else isInitiallyExpanded = sidebar.classList.contains('md:w-64');

            sidebar.querySelectorAll('span').forEach(span => {
                if (span.classList.contains('lg:inline')) {
                     span.classList.toggle('lg:inline', sidebar.classList.contains('lg:w-64'));
                } else {
                     span.classList.toggle('md:hidden', !isInitiallyExpanded);
                }
            });
            sidebar.querySelectorAll('.sidebar-link .material-icons, .sidebar-link .material-icons-outlined').forEach(icon => {
                icon.classList.toggle('ml-4', isInitiallyExpanded);
                icon.classList.toggle('ml-0', !isInitiallyExpanded);
            });
            if(sidebarExploreHeading) sidebarExploreHeading.classList.toggle('hidden', !isInitiallyExpanded);
        }

        function showAuthModal(showLogin = true) {
            isLoginMode = showLogin;
            authModalTitle.textContent = isLoginMode ? 'تسجيل الدخول إلى Streamsy' : 'إنشاء حساب جديد في Streamsy';
            authSubmitButton.textContent = isLoginMode ? 'تسجيل الدخول' : 'إنشاء حساب';
            authSwitchText.textContent = isLoginMode ? 'ليس لديك حساب؟' : 'لديك حساب بالفعل؟';
            authSwitchButton.textContent = isLoginMode ? 'إنشاء حساب جديد' : 'تسجيل الدخول';
            authError.classList.add('hidden'); authError.textContent = '';
            authForm.reset();
            authModal.classList.remove('hidden');
            bodyElement.classList.add('body-no-scroll');
        }
        function hideAuthModal() {
            authModal.classList.add('hidden');
            bodyElement.classList.remove('body-no-scroll');
        }

        auth.onAuthStateChanged(async user => {
            if (user) {
                const avatarSrc = user.photoURL || `https://ui-avatars.com/api/?name=${(user.email ? user.email.charAt(0).toUpperCase() : 'U')}&background=random&size=36&color=fff&font-size=0.5`;
                userSection.innerHTML = `<button id="user-menu-button" class="focus:outline-none"><img src="${avatarSrc}" alt="User Avatar" class="h-7 w-7 sm:h-8 sm:w-9 rounded-full object-cover border-2 border-transparent hover:border-red-400 transition-all"></button>`;
                if(dropdownUserAvatar) dropdownUserAvatar.src = avatarSrc;
                if(dropdownUserName) dropdownUserName.textContent = user.displayName || (user.email ? user.email.split('@')[0] : "مستخدم");
                if(dropdownUserEmail) dropdownUserEmail.textContent = user.email || "لا يوجد بريد إلكتروني";

                const userMenuButtonInternal = document.getElementById('user-menu-button');
                if (userMenuButtonInternal) userMenuButtonInternal.addEventListener('click', (e) => { e.stopPropagation(); if(userDropdown) userDropdown.classList.toggle('hidden'); });
                hideAuthModal();

                const userRef = db.collection('users').doc(user.uid);
                const userDoc = await userRef.get();
                if (!userDoc.exists) {
                    try {
                        await userRef.set({
                            uid: user.uid, email: user.email,
                            displayName: user.displayName || (user.email ? user.email.split('@')[0] : "مستخدم"),
                            photoURL: user.photoURL || `https://ui-avatars.com/api/?name=${user.email ? user.email.charAt(0).toUpperCase() : 'U'}&background=random&size=128&color=fff&font-size=0.33`,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            subscriberCount: 0, videoCount: 0,
                            channelDescription: "", channelCoverUrl: "",
                            interactionPoints: 0,
                            username: (user.email ? user.email.split('@')[0].toLowerCase().replace(/[^a-z0-9_]/gi, '') : "user") + Math.random().toString(36).substring(2, 6)
                        }, { merge: true });
                        if(dropdownUserPoints) dropdownUserPoints.textContent = '0 نقطة تفاعل';
                        console.log("User document created in Firestore with initial values on login.");
                    } catch (error) { console.error("Error ensuring user document exists:", error); }
                } else {
                     const userData = userDoc.data();
                     if(dropdownUserPoints) dropdownUserPoints.textContent = `${userData.interactionPoints || 0} نقطة تفاعل`;
                    const authDisplayName = user.displayName || (user.email ? user.email.split('@')[0] : "مستخدم");
                    const authPhotoURL = user.photoURL || `https://ui-avatars.com/api/?name=${user.email ? user.email.charAt(0).toUpperCase() : 'U'}&background=random&size=128&color=fff&font-size=0.33`;
                    if((userData.displayName !== authDisplayName || userData.photoURL !== authPhotoURL) && user.email) {
                         try {
                            await userRef.update({ displayName: authDisplayName, photoURL: authPhotoURL });
                            console.log("User document synced with Auth displayName/photoURL.");
                        } catch (error) { console.error("Error syncing user document with Auth:", error); }
                    }
                }
                // تحديث واجهة استوديو البث إذا كانت مفتوحة
                if (studioInfoModal && !studioInfoModal.classList.contains('hidden')) {
                     setupLiveStreamStudio();
                }

            } else {
                userSection.innerHTML = `<button id="show-login-modal-button" class="border-2 border-red-500 text-red-500 hover:bg-red-50 text-[10px] sm:text-xs font-semibold py-1 px-1.5 sm:py-1.5 sm:px-3 rounded-full flex items-center transition-all"><span class="material-icons-outlined text-sm sm:text-base ml-0.5 sm:ml-1">account_circle</span>تسجيل الدخول</button>`;
                if(userDropdown) userDropdown.classList.add('hidden');
                const showLoginModalButtonInternal = document.getElementById('show-login-modal-button');
                if (showLoginModalButtonInternal) showLoginModalButtonInternal.addEventListener('click', () => showAuthModal(true));
                // تحديث واجهة استوديو البث إذا كانت مفتوحة
                if (studioInfoModal && !studioInfoModal.classList.contains('hidden')) {
                    if(liveStreamLoginPrompt) liveStreamLoginPrompt.classList.remove('hidden');
                    if(liveStreamSetupInfo) liveStreamSetupInfo.classList.add('hidden');
                    if(liveStreamControls) liveStreamControls.classList.add('hidden');
                }
            }
            if (currentChannelIdForPlayer && playerSubscribeButton) updateSubscribeButtonUI(playerSubscribeButton, currentChannelIdForPlayer);
            if (currentChannelOwnerIdForPage && channelPageSubscribeButton) updateSubscribeButtonUI(channelPageSubscribeButton, currentChannelOwnerIdForPage);
            if (currentVideoIdForPlayer && moreVideoOptionsWrapper && currentVideoDataForPlayer) {
                 moreVideoOptionsWrapper.classList.toggle('hidden', !(user && user.uid === currentVideoDataForPlayer.uploaderId));
            }


             if (subscriptionsSection && !subscriptionsSection.classList.contains('hidden')) {
                loadSubscribedChannelsVideos();
            }
             if (likedVideosSection && !likedVideosSection.classList.contains('hidden')) {
                loadLikedVideos();
            }
            if (historySection && !historySection.classList.contains('hidden')) {
                loadHistoryVideos();
            }
            loadLiveNowStreams();
        });


        function createVideoCard(video) {
            const avatarInitial = (video.uploaderName || 'C').charAt(0).toUpperCase();
            const avatarHtml = video.uploaderAvatar ? `<img class="h-8 w-8 sm:h-9 sm:w-9 rounded-full object-cover bg-gray-200" src="${escapeHtml(video.uploaderAvatar)}" alt="${escapeHtml(video.uploaderName) || 'Channel'} Avatar">` : `<div class="h-8 w-8 sm:h-9 sm:w-9 rounded-full bg-gray-300 flex items-center justify-center text-white font-semibold text-sm">${avatarInitial}</div>`;
            const viewsText = video.views !== 'السجل' ? (video.views ? `${video.views} مشاهدة` : '0 مشاهدات') : 'من السجل';
            const dateText = video.uploadTimestamp ? new Date(video.uploadTimestamp.seconds * 1000).toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' }) : '';
            const originalBadge = video.isStreamsyOriginal ? `<span class="streamsy-original-badge">ORIGINAL</span>` : '';

            return `
            <div class="flex flex-col group cursor-pointer video-card-wrapper bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden border border-gray-200" data-video-id="${video.id}">
                <div class="relative block bg-gray-200">
                    <img class="w-full h-auto aspect-video object-cover group-hover:scale-105 transition-transform duration-300" src="${escapeHtml(video.thumbnailUrl) || 'https://via.placeholder.com/400x225.png?text=No+Thumbnail'}" alt="Thumbnail for ${escapeHtml(video.title) || 'Untitled'}">
                    <span class="absolute bottom-1.5 right-1.5 sm:bottom-2 sm:right-2 bg-black bg-opacity-75 text-white text-[10px] sm:text-xs px-1 sm:px-1.5 py-0.5 rounded">${video.duration || '0:00'}</span>
                    ${originalBadge}
                </div>
                <div class="p-2.5 sm:p-3.5 flex items-start">
                    <div class="shrink-0 ml-2 sm:ml-3 mt-0.5">${avatarHtml}</div>
                    <div class="flex-1">
                        <h3 class="text-sm font-semibold leading-tight text-gray-800 mb-0.5 sm:mb-1"><span class="hover:text-red-600 line-clamp-2">${escapeHtml(video.title) || 'فيديو بدون عنوان'}</span></h3>
                        <p class="text-xs text-gray-500 group-hover:text-gray-700"><span class="channel-name-clickable" data-channel-id="${escapeHtml(video.uploaderId)}">${escapeHtml(video.uploaderName) || 'قناة غير معروفة'}</span></p>
                        <p class="text-[10px] sm:text-xs text-gray-500"><span>${viewsText}</span> ${dateText ? `• <span>${dateText}</span>` : ''}</p>
                    </div>
                </div>
            </div>`;
        }

        async function loadAndDisplayVideos(videosSnapshotParam = null, isSearchResult = false, searchTerm = "") {
            if(!videoGrid || !loadingIndicator || !noVideosMessage || !searchNoResultsMessage) return;
            videoGrid.innerHTML = '';
            loadingIndicator.classList.remove('hidden');
            noVideosMessage.classList.add('hidden');
            searchNoResultsMessage.classList.add('hidden');
            allVideosDataCache = [];

            try {
                const docsToProcess = videosSnapshotParam?.docs
                                   ? videosSnapshotParam.docs
                                   : (Array.isArray(videosSnapshotParam)
                                        ? videosSnapshotParam.map(v => ({id: v.id, data: () => v }))
                                        : (await db.collection('videos').orderBy('uploadTimestamp', 'desc').limit(16).get()).docs);

                docsToProcess.forEach(doc => {
                    const videoData = doc.data();
                    allVideosDataCache.push({ id: doc.id, ...videoData });
                 });

                if (allVideosDataCache.length === 0) {
                    if (isSearchResult) {
                        searchQueryDisplay.textContent = searchTerm;
                        searchNoResultsMessage.classList.remove('hidden');
                    } else {
                        noVideosMessage.classList.remove('hidden');
                    }
                } else {
                    allVideosDataCache.forEach(video => videoGrid.innerHTML += createVideoCard(video));
                }
            } catch (error) {
                console.error("Error fetching videos:", error);
                videoGrid.innerHTML = '<p class="col-span-full text-center text-red-500">خطأ في تحميل الفيديوهات. تأكد من إنشاء الفهارس في Firestore.</p>';
            }
            loadingIndicator.classList.add('hidden');
        }

        async function handleSearch() {
            if(!searchInput || !loadingIndicator || !videoGrid || !noVideosMessage || !searchNoResultsMessage) return;
            const searchTerm = searchInput.value.trim().toLowerCase();
            navigateToHomeView(true);

            if (!searchTerm) {
                filterVideosByCategory(categoriesBar.querySelector('.category-button.active')?.dataset.category || 'all');
                return;
            }
            loadingIndicator.classList.remove('hidden');
            videoGrid.innerHTML = '';
            noVideosMessage.classList.add('hidden');
            searchNoResultsMessage.classList.add('hidden');

            try {
                const videosSnapshot = await db.collection('videos').orderBy('uploadTimestamp', 'desc').get();
                const filteredVideos = [];
                videosSnapshot.forEach(doc => {
                    const videoData = doc.data();
                    const titleMatch = videoData.title && videoData.title.toLowerCase().includes(searchTerm);
                    const descriptionMatch = videoData.description && videoData.description.toLowerCase().includes(searchTerm);
                    const tagsMatch = videoData.tags && videoData.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                    const categoryMatch = videoData.category && videoData.category.toLowerCase().includes(searchTerm);
                    const uploaderMatch = videoData.uploaderName && videoData.uploaderName.toLowerCase().includes(searchTerm);

                    if (titleMatch || descriptionMatch || tagsMatch || categoryMatch || uploaderMatch) {
                        filteredVideos.push({ id: doc.id, ...videoData });
                    }
                });
                loadAndDisplayVideos(filteredVideos, true, searchInput.value.trim());

            } catch (error) {
                console.error("Error during search:", error);
                videoGrid.innerHTML = '<p class="col-span-full text-center text-red-500">خطأ أثناء البحث.</p>';
                loadingIndicator.classList.add('hidden');
            }
        }

        async function addVideoToHistory(videoId, videoData) {
            const user = auth.currentUser;
            if (!user || !videoId || !videoData) return;

            try {
                const historyRef = db.collection('watchHistory').doc(`${user.uid}_${videoId}`);
                await historyRef.set({
                    userId: user.uid,
                    videoId: videoId,
                    title: videoData.title,
                    thumbnailUrl: videoData.thumbnailUrl,
                    uploaderName: videoData.uploaderName,
                    uploaderId: videoData.uploaderId,
                    uploaderAvatar: videoData.uploaderAvatar,
                    duration: videoData.duration,
                    watchedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                console.log("Video added/updated in history:", videoId);
                await updateUserInteractionPoints(user.uid, INTERACTION_POINTS.WATCH_VIDEO);
            } catch (error) {
                console.error("Error adding video to history:", error);
            }
        }


        async function showVideoPlayer(videoId, isLiveStream = false, liveHlsUrl = null, liveStreamTitle = null) {
            currentVideoIdForPlayer = videoId;
            hideAllMainSections();
            if(videoPlayerSection) videoPlayerSection.classList.remove('hidden');
            document.body.scrollTop = 0; document.documentElement.scrollTop = 0;
            isAutoplayCancelledManually = false;
            if (autoplayTimer) clearTimeout(autoplayTimer);
            if (autoplayOverlay) autoplayOverlay.classList.add('hidden');

            const isMobile = window.innerWidth < 768;
            if (!isMobile && sidebar) {
                 if (!previousSidebarState && !sidebar.classList.contains('lg:w-16') && !sidebar.classList.contains('md:w-16')) {
                    previousSidebarState = { classes: Array.from(sidebar.classList), overlayHidden: sidebarOverlay ? sidebarOverlay.classList.contains('hidden') : true };
                    sidebar.classList.remove('lg:w-64', 'md:w-64');
                    sidebar.classList.add('lg:w-16', 'md:w-16');
                    setInitialSidebarTextState();
                 }
            } else if (isMobile && sidebar && !sidebar.classList.contains('translate-x-full')) {
                 toggleSidebar();
            }

            if (window.innerWidth < 768) {
                if(suggestedVideosMobileContainer) suggestedVideosMobileContainer.classList.remove('hidden');
                if(suggestedVideosAside) suggestedVideosAside.classList.add('hidden');
            } else {
                if(suggestedVideosAside) suggestedVideosAside.classList.remove('hidden');
                if(suggestedVideosMobileContainer) suggestedVideosMobileContainer.classList.add('hidden');
            }

            if (unsubscribeVideoListener) unsubscribeVideoListener();
            if (unsubscribeCommentsListener) unsubscribeCommentsListener();

            // Initialize or re-initialize Video.js player for HLS if it's a live stream
            if (isLiveStream && liveHlsUrl) {
                 if(moreVideoOptionsWrapper) moreVideoOptionsWrapper.classList.add('hidden');
                 if(loopVideoButton) loopVideoButton.classList.add('hidden');
                 if(qualityControlsWrapper) qualityControlsWrapper.classList.add('hidden');
                 if(playerAddCommentForm) playerAddCommentForm.classList.add('hidden');
                 if(playerCommentsList) playerCommentsList.innerHTML = '<p class="text-sm text-gray-500 py-3">التعليقات غير متاحة للبث المباشر.</p>';
                 if(playerCommentsCountSpan) playerCommentsCountSpan.textContent = "0";
                 if(playerDescriptionContainer) playerDescriptionContainer.classList.add('hidden');
                 if(suggestedVideosAside) suggestedVideosAside.classList.add('hidden');
                 if(suggestedVideosMobileContainer) suggestedVideosMobileContainer.classList.add('hidden');
                 if(autoplayOverlay) autoplayOverlay.classList.add('hidden');


                if (!videoJsPlayer) {
                    videoJsPlayer = videojs(currentPlayer, {
                        html5: { hls: { overrideNative: true } },
                        autoplay: true,
                        muted: true // Start muted as per best practice
                    });
                }
                videoJsPlayer.src({ src: liveHlsUrl, type: 'application/x-mpegURL' });
                videoJsPlayer.load();
                videoJsPlayer.play().catch(e => console.warn("Video.js play error for live stream:", e));

                if(playerTitle) playerTitle.textContent = unescape(liveStreamTitle) || "بث مباشر";
                // Fetch and display uploader info for live stream
                db.collection('users').doc(videoId).get().then(userDoc => { // videoId is userId for live streams
                    if (userDoc.exists) {
                        const uploaderData = userDoc.data();
                        currentChannelIdForPlayer = videoId; // Set for subscribe button
                        if(playerChannelName) playerChannelName.textContent = uploaderData.displayName || "مستخدم";
                        if(playerChannelAvatar) playerChannelAvatar.src = uploaderData.photoURL || `https://ui-avatars.com/api/?name=${(uploaderData.displayName || 'U').charAt(0).toUpperCase()}&background=random&size=48&color=fff&font-size=0.4`;
                        if(playerChannelSubscribers) playerChannelSubscribers.textContent = `${uploaderData.subscriberCount || 0} مشترك`;
                        if(playerSubscribeButton) {
                            playerSubscribeButton.dataset.channelId = videoId;
                            updateSubscribeButtonUI(playerSubscribeButton, videoId);
                        }
                        if(playerChannelInfoClickable) playerChannelInfoClickable.dataset.channelId = videoId;
                    }
                });
                if(playerViews) playerViews.textContent = "مشاهدة مباشرة";
                if(playerUploadDateElem) playerUploadDateElem.textContent = "الآن";
                if(playerLikesCountSpan) playerLikesCountSpan.textContent = "-";
                if(playerDislikesCountSpan) playerDislikesCountSpan.textContent = "-";
                return; // Exit early for live streams
            }


            // --- Logic for VOD (Video on Demand) ---
            if (videoJsPlayer) { // If Video.js was initialized for a live stream, dispose it
                videoJsPlayer.dispose();
                videoJsPlayer = null;
                // Recreate the original video tag for HTML5 player
                const videoContainer = currentPlayer.parentElement;
                if (videoContainer) {
                    const newPlayer = document.createElement('video');
                    newPlayer.id = "current-video-player";
                    newPlayer.className = "w-full h-full"; // Keep original classes
                    newPlayer.controls = true;
                    newPlayer.setAttribute('controlsList', 'nodownload');
                    videoContainer.innerHTML = ''; // Clear Video.js remnants
                    videoContainer.appendChild(newPlayer);
                    // currentPlayer = newPlayer; // Re-assign to the new standard HTML5 player
                    // IMPORTANT: This re-assignment can cause issues if other parts of the code hold a reference to the old `currentPlayer`.
                    // A more robust solution might be to always use Video.js and just change its source,
                    // or ensure `currentPlayer` is always fetched by ID when needed after this potential replacement.
                    // For now, we proceed assuming `showVideoPlayer` will be the primary source of truth for `currentPlayer` when playing.
                }
            }
             // Ensure controls that might have been hidden for live stream are visible for VOD
            if(loopVideoButton) loopVideoButton.classList.remove('hidden');
            // qualityControlsWrapper will be handled by videoData check below
            if(playerAddCommentForm) playerAddCommentForm.classList.remove('hidden');


            try { await db.collection('videos').doc(videoId).update({ views: firebase.firestore.FieldValue.increment(1) }); console.log("View incremented for video:", videoId); } catch (err) { console.warn("View increment failed for video " + videoId + ":", err); }

            unsubscribeVideoListener = db.collection('videos').doc(videoId).onSnapshot(async (doc) => {
                if (doc.exists) {
                    currentVideoDataForPlayer = { id: doc.id, ...doc.data() };
                    const videoData = currentVideoDataForPlayer;
                    currentChannelIdForPlayer = videoData.uploaderId;
                    if (playerSubscribeButton) playerSubscribeButton.dataset.channelId = videoData.uploaderId;
                    if (playerChannelInfoClickable) playerChannelInfoClickable.dataset.channelId = videoData.uploaderId;

                    const currentUser = auth.currentUser;
                    if (moreVideoOptionsWrapper) {
                        moreVideoOptionsWrapper.classList.toggle('hidden', !(currentUser && videoData.uploaderId === currentUser.uid));
                    }


                    let videoUrlToPlay = videoData.videoUrl;

                    if (qualityControlsWrapper) qualityControlsWrapper.classList.add('hidden');
                    if (qualityOptionsDropdown) qualityOptionsDropdown.innerHTML = '';

                    if (videoData.videoUrls && typeof videoData.videoUrls === 'object' && Object.keys(videoData.videoUrls).length > 0) {
                        if (qualityControlsWrapper) qualityControlsWrapper.classList.remove('hidden');

                        const autoOptionLink = document.createElement('a');
                        autoOptionLink.href = "#"; autoOptionLink.textContent = "تلقائي"; autoOptionLink.dataset.qualityKey = "auto";
                        autoOptionLink.classList.add('block', 'px-4', 'py-2', 'text-sm', 'text-gray-700', 'hover:bg-gray-100', 'text-right');
                        if (qualityOptionsDropdown) qualityOptionsDropdown.appendChild(autoOptionLink);

                        let initialQualityForAuto = videoData.videoUrl;
                        if (videoData.videoUrls.high) initialQualityForAuto = videoData.videoUrls.high;
                        else if (videoData.videoUrls.medium) initialQualityForAuto = videoData.videoUrls.medium;
                        else if (videoData.videoUrls.low) initialQualityForAuto = videoData.videoUrls.low;

                        videoUrlToPlay = initialQualityForAuto;
                        autoOptionLink.classList.add('font-semibold', 'bg-gray-50');


                        Object.keys(videoData.videoUrls).forEach(qualityKey => {
                            if (videoData.videoUrls[qualityKey]) {
                                const qualityName = ({high: "عالية (1080p)", medium: "متوسطة (720p)", low: "منخفضة (480p)"})[qualityKey] || qualityKey.toUpperCase();
                                const optionLink = document.createElement('a');
                                optionLink.href = "#"; optionLink.textContent = qualityName; optionLink.dataset.qualityKey = qualityKey;
                                optionLink.classList.add('block', 'px-4', 'py-2', 'text-sm', 'text-gray-700', 'hover:bg-gray-100', 'text-right');
                                optionLink.onclick = (e) => { e.preventDefault(); switchVideoQuality(qualityKey); if(qualityOptionsDropdown) qualityOptionsDropdown.classList.add('hidden'); };
                                if (qualityOptionsDropdown) qualityOptionsDropdown.appendChild(optionLink);
                            }
                        });
                    } else {
                        videoUrlToPlay = videoData.videoUrl;
                    }

                    // Need to re-fetch currentPlayer if it was replaced
                    const currentVideoPlayerElement = document.getElementById('current-video-player');

                    if (currentVideoPlayerElement.src !== videoUrlToPlay) {
                        const currentTime = currentVideoPlayerElement.currentTime;
                        const isPaused = currentVideoPlayerElement.paused;
                        currentVideoPlayerElement.src = videoUrlToPlay;
                        currentVideoPlayerElement.load();
                        currentVideoPlayerElement.onloadedmetadata = () => {
                            if (currentTime > 1 && Math.abs(currentVideoPlayerElement.duration - (videoData.expectedDuration || currentVideoPlayerElement.duration)) < 2) {
                                currentVideoPlayerElement.currentTime = currentTime;
                             }
                            if (!isPaused || currentVideoPlayerElement.autoplay) {
                                currentVideoPlayerElement.play().catch(e => console.warn("Play after source change prevented:", e));
                            }
                        };
                     }

                    if(playerTitle) playerTitle.textContent = videoData.title || "فيديو بدون عنوان";
                    if(playerChannelName) playerChannelName.textContent = videoData.uploaderName || "قناة غير معروفة";
                    if(playerChannelAvatar) playerChannelAvatar.src = videoData.uploaderAvatar || `https://ui-avatars.com/api/?name=${(videoData.uploaderName || 'C').charAt(0).toUpperCase()}&background=random&size=48&color=fff&font-size=0.4`;

                    if (videoData.uploaderId) {
                        const uploaderDoc = await db.collection('users').doc(videoData.uploaderId).get();
                        if (uploaderDoc.exists) {
                           if(playerChannelSubscribers) playerChannelSubscribers.textContent = `${uploaderDoc.data().subscriberCount || 0} مشترك`;
                        } else {
                            if(playerChannelSubscribers) playerChannelSubscribers.textContent = '0 مشترك';
                        }
                        if (playerSubscribeButton) updateSubscribeButtonUI(playerSubscribeButton, videoData.uploaderId);
                    }

                    if(loopVideoButton && currentVideoPlayerElement) {
                        currentVideoPlayerElement.loop = videoData.loopByDefault || false;
                        loopVideoButton.classList.toggle('action-button-active', currentVideoPlayerElement.loop);
                        loopVideoButton.querySelector('.material-icons-outlined').textContent = currentVideoPlayerElement.loop ? 'repeat_one' : 'loop';
                    }


                    if (playerUploadDateElem) playerUploadDateElem.textContent = videoData.uploadTimestamp ? new Date(videoData.uploadTimestamp.seconds * 1000).toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' }) : 'غير معروف';
                    if (playerLikesCountSpan) playerLikesCountSpan.textContent = videoData.likes || 0;
                    if (playerDislikesCountSpan) playerDislikesCountSpan.textContent = videoData.dislikes || 0;
                    if (playerViews) playerViews.textContent = `${videoData.views || 0} مشاهدة`;

                    if(playerDescriptionContainer) playerDescriptionContainer.classList.toggle('hidden', !videoData.description);
                    if (videoData.description && playerDescriptionSnippet && playerDescriptionFull && playerToggleDescriptionButton) {
                        playerDescriptionSnippet.textContent = videoData.description;
                        playerDescriptionFull.textContent = videoData.description;
                        isPlayerDescriptionExpanded = false;
                        playerDescriptionSnippet.classList.remove('hidden'); playerDescriptionSnippet.classList.add('line-clamp-3');
                        playerDescriptionFull.classList.add('hidden');
                        playerToggleDescriptionButton.textContent = "عرض المزيد";

                        const tempVisible = playerDescriptionSnippet.classList.contains('hidden');
                        if (tempVisible) playerDescriptionSnippet.classList.remove('hidden');

                        const snippetHeight = playerDescriptionSnippet.offsetHeight;
                        playerDescriptionSnippet.classList.remove('line-clamp-3');
                        const fullHeight = playerDescriptionSnippet.scrollHeight;
                        playerDescriptionSnippet.classList.add('line-clamp-3');

                        if (tempVisible) playerDescriptionSnippet.classList.add('hidden');

                        if (fullHeight > snippetHeight + 10) {
                            playerToggleDescriptionButton.classList.remove('hidden');
                        } else {
                            playerToggleDescriptionButton.classList.add('hidden');
                            playerDescriptionSnippet.classList.remove('line-clamp-3');
                        }
                    }
                    addVideoToHistory(videoId, videoData);

                } else { console.error("Video not found!"); navigateToHomeView(false, true); alert("الفيديو غير موجود."); }
            }, error => console.error("Error fetching video details:", error));

            loadComments(videoId); checkUserLikeStatus(videoId); loadSuggestedVideos(videoId);
        }

        function createSuggestedVideoCard(video) {
            if (!video) return '';
            const viewsText = video.views ? `${video.views} مشاهدة` : '0 مشاهدات';
            const dateText = video.uploadTimestamp ? new Date(video.uploadTimestamp.seconds * 1000).toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' }) : '';
            const originalBadgeSmall = video.isStreamsyOriginal ? `<span class="absolute top-1 right-1 bg-gradient-to-r from-red-500 to-orange-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full shadow">ORIGINAL</span>` : '';
            return `
            <div class="flex items-start space-x-reverse space-x-2.5 group cursor-pointer suggested-video-item p-1 hover:bg-gray-100 rounded-lg" data-video-id="${video.id}">
                <div class="w-2/5 shrink-0 relative">
                    <div class="aspect-video bg-gray-200 rounded-md overflow-hidden shadow-sm">
                        <img src="${escapeHtml(video.thumbnailUrl) || 'https://via.placeholder.com/160x90.png?text=No+Thumb'}" alt="${escapeHtml(video.title)}" class="w-full h-full object-cover">
                    </div>
                    ${originalBadgeSmall}
                </div>
                <div class="w-3/5">
                    <h4 class="text-xs font-semibold text-gray-800 line-clamp-2 mb-0.5 group-hover:text-red-600">${escapeHtml(video.title) || 'فيديو بدون عنوان'}</h4>
                    <p class="text-[11px] text-gray-500 group-hover:text-gray-700 truncate channel-name-clickable" data-channel-id="${escapeHtml(video.uploaderId)}">${escapeHtml(video.uploaderName) || 'قناة غير معروفة'}</p>
                    <p class="text-[11px] text-gray-500">${viewsText} • ${dateText}</p>
                </div>
            </div>`;
        }

        async function loadSuggestedVideos(currentVideoIdToExclude) {
            suggestedVideosCache = [];
            let listElDesktop = document.getElementById('suggested-videos-list-desktop');
            let loadingElDesktop = document.getElementById('loading-suggested-indicator-desktop');
            let listElMobile = document.getElementById('suggested-videos-list-mobile');
            let loadingElMobile = document.getElementById('loading-suggested-indicator-mobile');

            if (suggestedVideosAside && !listElDesktop) {
                suggestedVideosAside.innerHTML = `
                    <h3 class="text-lg font-semibold mb-3.5 text-gray-800">مقاطع فيديو مقترحة</h3>
                    <div id="loading-suggested-indicator-desktop" class="text-center py-4 hidden"><span class="material-icons animate-spin text-3xl">refresh</span></div>
                    <div id="suggested-videos-list-desktop" class="space-y-3"></div>
                `;
                listElDesktop = document.getElementById('suggested-videos-list-desktop');
                loadingElDesktop = document.getElementById('loading-suggested-indicator-desktop');
            }
             if (suggestedVideosMobileContainer && !listElMobile) {
                suggestedVideosMobileContainer.innerHTML = `
                    <h3 class="text-md font-semibold mb-3 text-gray-800">مقاطع فيديو مقترحة</h3>
                    <div id="loading-suggested-indicator-mobile" class="text-center py-3 hidden"><span class="material-icons animate-spin text-2xl">refresh</span></div>
                    <div id="suggested-videos-list-mobile" class="space-y-2.5"></div>
                `;
                listElMobile = document.getElementById('suggested-videos-list-mobile');
                loadingElMobile = document.getElementById('loading-suggested-indicator-mobile');
            }

            if (!listElDesktop || !loadingElDesktop || !listElMobile || !loadingElMobile) {
                console.warn("Suggested videos list/loader elements not found.");
                return;
            }

            listElDesktop.innerHTML = ''; listElMobile.innerHTML = '';
            loadingElDesktop.classList.remove('hidden'); loadingElMobile.classList.remove('hidden');
            let fetchedVideos = [];

            try {
                const currentVideoDoc = await db.collection('videos').doc(currentVideoIdToExclude).get();
                if (currentVideoDoc.exists) {
                    const currentVideoData = currentVideoDoc.data();
                    if (currentVideoData.category) {
                        const categoryQuery = db.collection('videos').where('category', '==', currentVideoData.category).orderBy('uploadTimestamp', 'desc').limit(7);
                        const categorySnapshot = await categoryQuery.get();
                        categorySnapshot.forEach(doc => { if (doc.id !== currentVideoIdToExclude && fetchedVideos.length < 6 && !fetchedVideos.some(v => v.id === doc.id)) { fetchedVideos.push({ id: doc.id, ...doc.data() }); } });
                    }
                }
                if (fetchedVideos.length < 12) {
                    const generalQuery = db.collection('videos').orderBy('uploadTimestamp', 'desc').limit(15);
                    const generalSnapshot = await generalQuery.get();
                    generalSnapshot.forEach(doc => { if (doc.id !== currentVideoIdToExclude && !fetchedVideos.some(v => v.id === doc.id) && fetchedVideos.length < 12) { fetchedVideos.push({ id: doc.id, ...doc.data() }); } });
                }

                suggestedVideosCache = [...fetchedVideos];

                if (fetchedVideos.length === 0) { const msg = '<p class="text-sm text-gray-500 p-2">لا توجد فيديوهات مقترحة حالياً.</p>'; listElDesktop.innerHTML = msg; listElMobile.innerHTML = msg; }
                else { fetchedVideos.forEach(video => { const cardHtml = createSuggestedVideoCard(video); listElDesktop.innerHTML += cardHtml; listElMobile.innerHTML += cardHtml; }); }
            } catch (error) { console.error("Error fetching suggested videos:", error); const msg = '<p class="text-sm text-red-500 p-2">خطأ في تحميل المقترحات.</p>'; listElDesktop.innerHTML = msg; listElMobile.innerHTML = msg; if (error.code === 'failed-precondition') { const idxMsg = '<p class="text-sm text-orange-500 p-2">تحميل المقترحات يتطلب فهرسًا. يرجى مراجعة الكونسول لإنشائه.</p>'; listElDesktop.innerHTML = idxMsg; listElMobile.innerHTML = idxMsg;}}
            finally {
                if(loadingElDesktop) loadingElDesktop.classList.add('hidden');
                if(loadingElMobile) loadingElMobile.classList.add('hidden');
            }
        }

        function handleSuggestedVideoClick(e) {
            const item = e.target.closest('.suggested-video-item[data-video-id]');
            if (item && item.dataset.videoId) {
                if (autoplayTimer) clearTimeout(autoplayTimer);
                if (autoplayOverlay) autoplayOverlay.classList.add('hidden');
                 const currentVideoPlayerElement = document.getElementById('current-video-player');
                if (currentVideoPlayerElement) currentVideoPlayerElement.pause();
                showVideoPlayer(item.dataset.videoId);
            }
        }

        async function loadComments(videoId) {
            if(!playerCommentsList) return;
            playerCommentsList.innerHTML = '<div class="text-center py-3 text-gray-500"><span class="material-icons animate-spin">refresh</span> جارٍ تحميل التعليقات...</div>';
            try {
                unsubscribeCommentsListener = db.collection('comments').where('videoId', '==', videoId).orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                    playerCommentsList.innerHTML = '';
                    if(playerCommentsCountSpan) playerCommentsCountSpan.textContent = snapshot.size;
                    if (snapshot.empty) { playerCommentsList.innerHTML = '<p class="text-sm text-gray-500 py-3">لا توجد تعليقات. كن أول من يعلق!</p>'; return; }
                    snapshot.forEach(doc => { const comment = doc.data(); const div = document.createElement('div'); div.className = 'flex items-start space-x-reverse space-x-2 sm:space-x-3 py-2 border-b border-gray-100 last:border-b-0'; const avatar = comment.userAvatar || `https://ui-avatars.com/api/?name=${(comment.userName || 'U').charAt(0).toUpperCase()}&background=random&size=32&color=fff&font-size=0.5`; div.innerHTML = `<img src="${escapeHtml(avatar)}" alt="${escapeHtml(comment.userName)}" class="w-8 h-8 sm:w-9 sm:h-9 rounded-full object-cover"><div class="flex-1"><p class="font-semibold text-xs sm:text-sm text-gray-800">${escapeHtml(comment.userName)} <span class="text-[10px] sm:text-xs text-gray-500 font-normal">${comment.timestamp ? new Date(comment.timestamp.seconds * 1000).toLocaleString('ar-EG', {day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'}) : ''}</span></p><p class="text-xs sm:text-sm mt-0.5 sm:mt-1 break-words whitespace-pre-wrap">${escapeHtml(comment.text)}</p></div>`; playerCommentsList.appendChild(div); });
                }, error => { console.error("Error loading comments (onSnapshot):", error); let msg = '<p class="text-red-500 py-3">فشل تحميل التعليقات.'; if (error.code === 'failed-precondition') { msg += ' قد تحتاج لإنشاء فهرس في Firestore على (videoId تصاعدي, timestamp تنازلي). راجع الكونسول للمزيد من المعلومات.';} msg += '</p>'; playerCommentsList.innerHTML = msg; });
            } catch (error) { console.error("Outer error attempting to load comments:", error); playerCommentsList.innerHTML = '<p class="text-red-500 py-3">خطأ عام أثناء محاولة تحميل التعليقات.</p>'; }
        }

        async function handleLikeDislike(actionType, videoId, uploaderId) {
            const user = auth.currentUser;
            if (!user) { alert('يجب تسجيل الدخول للتفاعل.'); showAuthModal(true); return; }
            if (!videoId) return;
            const videoRef = db.collection('videos').doc(videoId);
            const likeDocId = `${user.uid}_${videoId}`;
            const userLikeRef = db.collection('likes').doc(likeDocId);
            try {
                let pointsForUser = 0;
                let pointsForUploader = 0;

                await db.runTransaction(async (transaction) => {
                    const videoDoc = await transaction.get(videoRef);
                    const userLikeDoc = await transaction.get(userLikeRef);
                    if (!videoDoc.exists) throw "Video not found!";
                    const videoData = videoDoc.data();
                    const videoInfoForLike = {
                        title: videoData.title,
                        thumbnailUrl: videoData.thumbnailUrl,
                        uploaderName: videoData.uploaderName,
                        uploaderId: videoData.uploaderId,
                        uploaderAvatar: videoData.uploaderAvatar,
                        duration: videoData.duration
                     };

                    let updateData = {};
                    let interaction = { userId: user.uid, videoId: videoId, type: null, timestamp: firebase.firestore.FieldValue.serverTimestamp(), ...videoInfoForLike };
                    const currentType = userLikeDoc.exists ? userLikeDoc.data().type : null;

                    if (actionType === 'like') {
                        if (currentType === 'like') {
                            updateData.likes = firebase.firestore.FieldValue.increment(-1);
                            transaction.delete(userLikeRef);
                            pointsForUser = -INTERACTION_POINTS.LIKE;
                            pointsForUploader = -INTERACTION_POINTS.LIKE;
                        } else {
                            updateData.likes = firebase.firestore.FieldValue.increment(1);
                            if (currentType === 'dislike') updateData.dislikes = firebase.firestore.FieldValue.increment(-1);
                            interaction.type = 'like';
                            transaction.set(userLikeRef, interaction);
                            pointsForUser = INTERACTION_POINTS.LIKE;
                            pointsForUploader = INTERACTION_POINTS.LIKE;
                        }
                    } else if (actionType === 'dislike') {
                        if (currentType === 'dislike') {
                            updateData.dislikes = firebase.firestore.FieldValue.increment(-1);
                            transaction.delete(userLikeRef);
                        } else {
                            updateData.dislikes = firebase.firestore.FieldValue.increment(1);
                            if (currentType === 'like') {
                                updateData.likes = firebase.firestore.FieldValue.increment(-1);
                                pointsForUser = -INTERACTION_POINTS.LIKE;
                                pointsForUploader = -INTERACTION_POINTS.LIKE;
                            }
                            interaction.type = 'dislike';
                            transaction.set(userLikeRef, interaction);
                        }
                    }
                    if (Object.keys(updateData).length > 0) transaction.update(videoRef, updateData);
                });
                checkUserLikeStatus(videoId);
                if (pointsForUser !== 0) await updateUserInteractionPoints(user.uid, pointsForUser);
                if (pointsForUploader !== 0 && uploaderId && uploaderId !== user.uid) await updateUserInteractionPoints(uploaderId, pointsForUploader);

            } catch (error) { console.error("Error processing like/dislike:", error); alert("خطأ في معالجة التفاعل.");}
        }

        async function checkUserLikeStatus(videoId) {
            if(!playerLikeButton || !playerDislikeButton) return;
            playerLikeButton.classList.remove('action-button-active', 'like');
            playerDislikeButton.classList.remove('action-button-active', 'dislike');
            const user = auth.currentUser;
            if (!user || !videoId) return;
            const likeDocId = `${user.uid}_${videoId}`;
            try {
                const doc = await db.collection('likes').doc(likeDocId).get();
                if (doc.exists) {
                    const data = doc.data();
                    if (data.type === 'like') playerLikeButton.classList.add('action-button-active', 'like');
                    else if (data.type === 'dislike') playerDislikeButton.classList.add('action-button-active', 'dislike');
                }
            } catch(error){ console.error("Error checking like status:", error); }
        }

        async function filterVideosByCategory(category) {
            if(!videoGrid || !loadingIndicator || !noVideosMessage || !searchNoResultsMessage) return;
            videoGrid.innerHTML = '';
            loadingIndicator.classList.remove('hidden');
            noVideosMessage.classList.add('hidden');
            searchNoResultsMessage.classList.add('hidden');
            if(searchInput) searchInput.value = "";
            try {
                let query = db.collection('videos').orderBy('uploadTimestamp', 'desc');
                if (category === 'originals') {
                    query = query.where('isStreamsyOriginal', '==', true);
                } else if (category !== 'all') {
                    query = query.where('category', '==', category);
                }
                const videosSnapshot = await query.get();
                loadAndDisplayVideos(videosSnapshot, false);
            }
            catch (error) { console.error("Error filtering videos by category:", error); videoGrid.innerHTML = '<p class="col-span-full text-center text-red-500">خطأ في تحميل فيديوهات هذا التصنيف.</p>'; if (error.code === 'failed-precondition') videoGrid.innerHTML += '<p class="col-span-full text-center text-orange-500 text-sm">قد تحتاج لإنشاء فهرس في Firestore لهذا التصنيف. راجع الكونسول.</p>'; }
            loadingIndicator.classList.add('hidden');
        }

        function showChannelPageInternal(userIdToShow) {
             if (userIdToShow) {
                showChannelPage(userIdToShow);
                if(userDropdown) userDropdown.classList.add('hidden');
                if (window.innerWidth < 768 && sidebar && !sidebar.classList.contains('translate-x-full')) toggleSidebar();
            } else if (auth.currentUser){
                showChannelPage(auth.currentUser.uid);
                 if(userDropdown) userDropdown.classList.add('hidden');
                if (window.innerWidth < 768 && sidebar && !sidebar.classList.contains('translate-x-full')) toggleSidebar();
            } else {
                showAuthModal(true);
            }
        }

        async function showChannelPage(userId) {
            if(!channelPageSection || !channelPageName || !myVideosGrid) return;
            hideAllMainSections(); channelPageSection.classList.remove('hidden'); document.body.scrollTop = 0; document.documentElement.scrollTop = 0;
            currentChannelOwnerIdForPage = userId;
            if(channelPageSubscribeButton) channelPageSubscribeButton.dataset.channelId = userId;

            const user = auth.currentUser;
            if(editChannelButton) editChannelButton.classList.toggle('hidden', !(user && user.uid === userId));
            if(channelPageSubscribeButton) channelPageSubscribeButton.classList.toggle('hidden', user && user.uid === userId);

            try {
                const userDoc = await db.collection('users').doc(userId).get();
                let channelData = {};
                if (userDoc.exists) {
                    channelData = userDoc.data();
                    console.log("Fetched channel data for profile:", channelData);
                } else if (user && userId === user.uid) {
                    channelData = {
                        displayName: user.displayName || (user.email ? user.email.split('@')[0] : "مستخدم"),
                        email: user.email, photoURL: user.photoURL,
                        subscriberCount: 0, videoCount: 0,
                        interactionPoints: 0,
                        username: (user.email ? user.email.split('@')[0].toLowerCase().replace(/[^a-z0-9_]/gi, '') : "user") + Math.random().toString(36).substring(2,6)
                    };
                    await db.collection('users').doc(user.uid).set(channelData, { merge: true });
                    console.log("Created initial channel data for current user:", channelData);
                } else {
                    console.error("User document not found for ID:", userId);
                    channelPageName.textContent = "قناة غير موجودة";
                    return;
                }

                if(channelPageAvatar) channelPageAvatar.src = channelData.photoURL || `https://ui-avatars.com/api/?name=${(channelData.displayName || channelData.email || 'U').charAt(0).toUpperCase()}&background=random&size=128&color=fff&font-size=0.33`;
                channelPageName.textContent = channelData.displayName || (channelData.email ? channelData.email.split('@')[0] : 'مستخدم غير معروف');
                if(channelPageHandle) channelPageHandle.textContent = `@${channelData.username || (channelData.email ? channelData.email.split('@')[0].toLowerCase().replace(/[^a-z0-9_]/gi, '') : userId.substring(0,8))}`;
                if(channelPageCoverPhoto) channelPageCoverPhoto.src = channelData.channelCoverUrl || 'https://via.placeholder.com/1200x300?text=Cover+Photo+by+Streamsy';
                if(channelPageDescription) channelPageDescription.textContent = channelData.channelDescription || 'لا يوجد وصف للقناة بعد.';
                if(channelPageDescription) channelPageDescription.classList.toggle('text-gray-500', !channelData.channelDescription);
                if(channelPageSubscriberCount) channelPageSubscriberCount.textContent = `${channelData.subscriberCount || 0} مشترك`;
                if(channelPagePoints) channelPagePoints.textContent = `${channelData.interactionPoints || 0} نقطة تفاعل`;

                if(channelPageSubscribeButton) updateSubscribeButtonUI(channelPageSubscribeButton, userId);

                myVideosGrid.innerHTML = '';
                if(noMyVideosMessageEl) noMyVideosMessageEl.classList.add('hidden');
                if(loadingIndicator) loadingIndicator.classList.remove('hidden');
                updateActiveSidebarLink(user && user.uid === userId ? 'sidebar-your-channel-button': '');

                const videosSnapshot = await db.collection('videos').where('uploaderId', '==', userId).orderBy('uploadTimestamp', 'desc').get();
                console.log(`Fetched ${videosSnapshot.size} videos for channel ${userId}`);

                if(channelPageVideoCount) channelPageVideoCount.textContent = `${videosSnapshot.size} فيديوهات`;
                if (user && user.uid === userId && (channelData.videoCount === undefined || channelData.videoCount !== videosSnapshot.size)) {
                    try {
                       await db.collection('users').doc(userId).update({ videoCount: videosSnapshot.size });
                    } catch (updateError) {
                        console.warn("Could not update videoCount on user doc:", updateError)
                    }
                }

                if (videosSnapshot.empty) { if(noMyVideosMessageEl) noMyVideosMessageEl.classList.remove('hidden'); }
                else { videosSnapshot.forEach(doc => myVideosGrid.innerHTML += createMyVideoCard({ id: doc.id, ...doc.data() })); }

            } catch (error) {
                console.error("Error fetching channel data or user's videos:", error);
                if (channelPageName) channelPageName.textContent = "خطأ في تحميل القناة";
                let msg = "<p class='text-red-500 col-span-full text-center'>خطأ في تحميل فيديوهات القناة.";
                if (error.code === 'failed-precondition') msg += " قد تحتاج لإنشاء فهرس في Firestore (على uploaderId و uploadTimestamp). راجع الكونسول للمزيد.";
                msg += "</p>";
                if (myVideosGrid) myVideosGrid.innerHTML = msg;
            }
            if(loadingIndicator) loadingIndicator.classList.add('hidden');
        }

        function createMyVideoCard(video) {
            const originalBadgeSmall = video.isStreamsyOriginal ? `<span class="absolute top-1.5 right-1.5 bg-gradient-to-r from-red-500 to-orange-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full shadow">ORIGINAL</span>` : '';
            return `
            <div class="bg-white rounded-lg shadow-lg p-3 sm:p-4 group relative border border-gray-200 hover:shadow-xl transition-shadow duration-200">
                <div class="relative mb-2 sm:mb-3 cursor-pointer" onclick="showVideoPlayer('${video.id}')">
                    <img src="${escapeHtml(video.thumbnailUrl) || 'https://via.placeholder.com/300x169'}" alt="${escapeHtml(video.title)}" class="w-full h-32 sm:h-40 object-cover rounded-md bg-gray-200">
                    ${originalBadgeSmall}
                    <div class="absolute top-1.5 left-1.5 sm:top-2 sm:left-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex space-x-1 space-x-reverse bg-black/50 p-1 rounded-md">
                        <button class="edit-my-video-btn p-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 text-xs shadow-md" data-video-id="${video.id}" data-title="${escape(video.title)}" data-description="${escape(video.description || '')}" data-category="${video.category || ''}" data-tags="${video.tags ? video.tags.join(',') : ''}" data-is-original="${video.isStreamsyOriginal || false}"><span class="material-icons" style="font-size: 14px sm:font-size: 16px;">edit</span></button>
                        <button class="delete-my-video-btn p-1 bg-red-500 text-white rounded-full hover:bg-red-600 text-xs shadow-md" data-video-id="${video.id}" data-video-url="${escapeHtml(video.videoUrl)}" data-thumbnail-url="${escapeHtml(video.thumbnailUrl)}"><span class="material-icons" style="font-size: 14px sm:font-size: 16px;">delete</span></button>
                    </div>
                </div>
                <h3 class="font-semibold text-sm sm:text-md mb-1 line-clamp-2 text-gray-800 cursor-pointer" onclick="showVideoPlayer('${video.id}')">${escapeHtml(video.title)}</h3>
                <p class="text-xs text-gray-500">${video.views || 0} مشاهدة • ${video.uploadTimestamp ? new Date(video.uploadTimestamp.seconds * 1000).toLocaleDateString('ar-EG', { year: 'numeric', month: 'short' }) : ''}</p>
            </div>`;
        }

        function switchVideoQuality(qualityKey) {
            const currentVideoPlayerElement = document.getElementById('current-video-player');
            if (!currentVideoDataForPlayer || !currentVideoPlayerElement) { console.warn("Video data or player not available for quality switch."); return; }

            let newSrc = null;
            if (qualityKey === "auto") {
                newSrc = currentVideoDataForPlayer.videoUrl;
                if (currentVideoDataForPlayer.videoUrls) {
                    if (currentVideoDataForPlayer.videoUrls.high) newSrc = currentVideoDataForPlayer.videoUrls.high;
                    else if (currentVideoDataForPlayer.videoUrls.medium) newSrc = currentVideoDataForPlayer.videoUrls.medium;
                    else if (currentVideoDataForPlayer.videoUrls.low) newSrc = currentVideoDataForPlayer.videoUrls.low;
                }
            } else if (currentVideoDataForPlayer.videoUrls && currentVideoDataForPlayer.videoUrls[qualityKey]) {
                newSrc = currentVideoDataForPlayer.videoUrls[qualityKey];
            } else {
                 console.warn("Selected quality key not found in videoUrls:", qualityKey);
                 newSrc = currentVideoDataForPlayer.videoUrl;
                 qualityKey = "auto";
            }

            if (currentVideoPlayerElement.src === newSrc) return;

            const currentTime = currentVideoPlayerElement.currentTime;
            const isPaused = currentVideoPlayerElement.paused;
            currentVideoPlayerElement.src = newSrc;
            currentVideoPlayerElement.load();
            currentVideoPlayerElement.onloadedmetadata = () => {
                currentVideoPlayerElement.currentTime = currentTime;
                if (!isPaused || currentVideoPlayerElement.autoplay) {
                    currentVideoPlayerElement.play().catch(e => console.warn("Autoplay after quality switch prevented:", e));
                }
            };

            if(qualityOptionsDropdown) {
                qualityOptionsDropdown.querySelectorAll('a').forEach(link => {
                    link.classList.remove('font-semibold', 'bg-gray-50');
                    if (link.dataset.qualityKey === qualityKey) {
                        link.classList.add('font-semibold', 'bg-gray-50');
                    }
                });
            }
        }


        async function handleSubscription(channelOwnerId) {
            const currentUser = auth.currentUser;
            if (!currentUser) { alert('يجب تسجيل الدخول للاشتراك.'); showAuthModal(true); return; }
            if (currentUser.uid === channelOwnerId) { alert('لا يمكنك الاشتراك في قناتك.'); return; }

            const subscriberId = currentUser.uid;
            const subscriptionDocId = `${subscriberId}_${channelOwnerId}`;
            const subscriptionRef = db.collection('subscriptions').doc(subscriptionDocId);
            const channelUserRef = db.collection('users').doc(channelOwnerId);
            const subscriberUserRef = db.collection('users').doc(subscriberId);

            try {
                const subDoc = await subscriptionRef.get();
                if (subDoc.exists) {
                    await db.runTransaction(async (transaction) => {
                        transaction.delete(subscriptionRef);
                        transaction.update(channelUserRef, { subscriberCount: firebase.firestore.FieldValue.increment(-1) });
                        if(INTERACTION_POINTS.SUBSCRIBE) {
                            transaction.update(subscriberUserRef, { interactionPoints: firebase.firestore.FieldValue.increment(-INTERACTION_POINTS.SUBSCRIBE) });
                            transaction.update(channelUserRef, { interactionPoints: firebase.firestore.FieldValue.increment(-INTERACTION_POINTS.SUBSCRIBE) });
                        }
                    });
                    console.log('Unsubscribed');
                } else {
                     await db.runTransaction(async (transaction) => {
                        transaction.set(subscriptionRef, {
                            subscriberId: subscriberId,
                            channelOwnerId: channelOwnerId,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        const channelOwnerDoc = await transaction.get(channelUserRef);
                        if (!channelOwnerDoc.exists) {
                             transaction.set(channelUserRef, {
                                subscriberCount: 1,
                                interactionPoints: INTERACTION_POINTS.SUBSCRIBE || 0
                             }, { merge: true });
                        } else {
                             transaction.update(channelUserRef, {
                                subscriberCount: firebase.firestore.FieldValue.increment(1),
                                interactionPoints: firebase.firestore.FieldValue.increment(INTERACTION_POINTS.SUBSCRIBE || 0)
                            });
                        }
                        if(INTERACTION_POINTS.SUBSCRIBE) {
                            transaction.update(subscriberUserRef, { interactionPoints: firebase.firestore.FieldValue.increment(INTERACTION_POINTS.SUBSCRIBE) });
                        }
                    });
                    console.log('Subscribed');
                }
                if (playerSubscribeButton) updateSubscribeButtonUI(playerSubscribeButton, channelOwnerId);
                if (channelPageSubscribeButton) updateSubscribeButtonUI(channelPageSubscribeButton, channelOwnerId);

                if (videoPlayerSection && !videoPlayerSection.classList.contains('hidden') && currentChannelIdForPlayer === channelOwnerId) {
                    const uploaderDoc = await db.collection('users').doc(channelOwnerId).get();
                    if (uploaderDoc.exists && playerChannelSubscribers) playerChannelSubscribers.textContent = `${uploaderDoc.data().subscriberCount || 0} مشترك`;
                }
                if (channelPageSection && !channelPageSection.classList.contains('hidden') && currentChannelOwnerIdForPage === channelOwnerId) {
                    const uploaderDoc = await db.collection('users').doc(channelOwnerId).get();
                     if (uploaderDoc.exists && channelPageSubscriberCount) channelPageSubscriberCount.textContent = `${uploaderDoc.data().subscriberCount || 0} مشترك`;
                }
                if (auth.currentUser) {
                    const updatedUserDoc = await subscriberUserRef.get();
                    if (updatedUserDoc.exists && dropdownUserPoints) dropdownUserPoints.textContent = `${updatedUserDoc.data().interactionPoints || 0} نقطة تفاعل`;
                }

            } catch (error) {
                console.error("Error handling subscription:", error);
                alert('حدث خطأ أثناء معالجة الاشتراك.');
            }
        }

        async function updateSubscribeButtonUI(buttonElement, channelOwnerId) {
            if (!buttonElement || buttonElement.dataset.channelId !== channelOwnerId) return;

            const currentUser = auth.currentUser;
            if (!currentUser || currentUser.uid === channelOwnerId) {
                buttonElement.classList.add('hidden');
                return;
            }
            buttonElement.classList.remove('hidden');

            const subscriptionDocId = `${currentUser.uid}_${channelOwnerId}`;
            const subscriptionRef = db.collection('subscriptions').doc(subscriptionDocId);

            try {
                const subDoc = await subscriptionRef.get();
                if (subDoc.exists) {
                    buttonElement.textContent = 'إلغاء الاشتراك';
                    buttonElement.classList.remove('bg-red-600', 'hover:bg-red-700');
                    buttonElement.classList.add('bg-gray-600', 'hover:bg-gray-700');
                } else {
                    buttonElement.textContent = 'اشتراك';
                    buttonElement.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                    buttonElement.classList.add('bg-red-600', 'hover:bg-red-700');
                }
            } catch (error) {
                console.error("Error updating subscribe button UI:", error);
            }
        }

        async function loadSubscribedChannelsVideos() {
            if(!subscriptionsGrid || !noSubscriptionsMessage || !loadingSubscriptionsIndicator) return;
            const currentUser = auth.currentUser;
            if (!currentUser) {
                subscriptionsGrid.innerHTML = '';
                noSubscriptionsMessage.textContent = 'يجب تسجيل الدخول لعرض الاشتراكات.';
                noSubscriptionsMessage.classList.remove('hidden');
                loadingSubscriptionsIndicator.classList.add('hidden');
                return;
            }

            subscriptionsGrid.innerHTML = '';
            noSubscriptionsMessage.classList.add('hidden');
            loadingSubscriptionsIndicator.classList.remove('hidden');

            try {
                const subscriptionsSnapshot = await db.collection('subscriptions')
                    .where('subscriberId', '==', currentUser.uid)
                    .get();

                if (subscriptionsSnapshot.empty) {
                    noSubscriptionsMessage.textContent = 'لم تشترك في أي قنوات بعد، أو أن القنوات التي اشتركت بها لم ترفع فيديوهات جديدة.';
                    noSubscriptionsMessage.classList.remove('hidden');
                    loadingSubscriptionsIndicator.classList.add('hidden');
                    return;
                }

                const subscribedChannelIds = subscriptionsSnapshot.docs.map(doc => doc.data().channelOwnerId);

                if (subscribedChannelIds.length === 0) {
                     noSubscriptionsMessage.classList.remove('hidden');
                     loadingSubscriptionsIndicator.classList.add('hidden');
                     return;
                }
                const channelIdsToQuery = subscribedChannelIds.slice(0, 10);
                if (channelIdsToQuery.length === 0) {
                     noSubscriptionsMessage.classList.remove('hidden');
                     loadingSubscriptionsIndicator.classList.add('hidden');
                     return;
                }

                const videosQuery = db.collection('videos')
                                    .where('uploaderId', 'in', channelIdsToQuery)
                                    .orderBy('uploadTimestamp', 'desc')
                                    .limit(20);

                const videosSnapshot = await videosQuery.get();
                if (videosSnapshot.empty) {
                    noSubscriptionsMessage.textContent = 'القنوات التي اشتركت بها لم ترفع أي فيديوهات جديدة بعد.';
                    noSubscriptionsMessage.classList.remove('hidden');
                } else {
                    videosSnapshot.forEach(doc => {
                        subscriptionsGrid.innerHTML += createVideoCard({ id: doc.id, ...doc.data() });
                    });
                }
            } catch (error) {
                console.error("Error loading subscribed channels' videos:", error);
                subscriptionsGrid.innerHTML = '<p class="col-span-full text-center text-red-500">خطأ في تحميل فيديوهات الاشتراكات.</p>';
                 if (error.code === 'failed-precondition') subscriptionsGrid.innerHTML += '<p class="col-span-full text-center text-orange-500 text-sm">قد تحتاج لإنشاء فهرس في Firestore. راجع الكونسول.</p>';
            } finally {
                loadingSubscriptionsIndicator.classList.add('hidden');
            }
        }

        async function loadLikedVideos() {
            if(!likedVideosSection || !likedVideosGrid || !noLikedVideosMessage || !loadingLikedVideosIndicator) return;
            hideAllMainSections();
            likedVideosSection.classList.remove('hidden');
            updateActiveSidebarLink('sidebar-liked-videos-button');
            document.body.scrollTop = 0; document.documentElement.scrollTop = 0;
            if (window.innerWidth < 768 && sidebar && !sidebar.classList.contains('translate-x-full')) toggleSidebar();

            const currentUser = auth.currentUser;
            if (!currentUser) {
                likedVideosGrid.innerHTML = '';
                noLikedVideosMessage.textContent = 'يجب تسجيل الدخول لعرض الفيديوهات المعجب بها.';
                noLikedVideosMessage.classList.remove('hidden');
                loadingLikedVideosIndicator.classList.add('hidden');
                return;
            }

            likedVideosGrid.innerHTML = '';
            noLikedVideosMessage.classList.add('hidden');
            loadingLikedVideosIndicator.classList.remove('hidden');

            try {
                const likesSnapshot = await db.collection('likes')
                    .where('userId', '==', currentUser.uid)
                    .where('type', '==', 'like')
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();

                if (likesSnapshot.empty) {
                    noLikedVideosMessage.classList.remove('hidden');
                } else {
                    likesSnapshot.forEach(likeDoc => {
                        const likeData = likeDoc.data();
                        likedVideosGrid.innerHTML += createVideoCard({
                            id: likeData.videoId,
                            title: likeData.title,
                            thumbnailUrl: likeData.thumbnailUrl,
                            uploaderName: likeData.uploaderName,
                            uploaderId: likeData.uploaderId,
                            uploaderAvatar: likeData.uploaderAvatar,
                            duration: likeData.duration,
                            views: likeData.views || 0,
                            uploadTimestamp: likeData.timestamp
                        });
                    });
                }
            } catch (error) {
                console.error("Error loading liked videos:", error);
                likedVideosGrid.innerHTML = '<p class="col-span-full text-center text-red-500">خطأ في تحميل الفيديوهات المعجب بها.</p>';
                 if (error.code === 'failed-precondition') likedVideosGrid.innerHTML += '<p class="col-span-full text-center text-orange-500 text-sm">يتطلب فهرسًا على (userId, type, timestamp). راجع الكونسول.</p>';
            } finally {
                loadingLikedVideosIndicator.classList.add('hidden');
            }
        }

        async function loadHistoryVideos() {
            if(!historySection || !historyGrid || !noHistoryMessage || !loadingHistoryIndicator) return;
            hideAllMainSections();
            historySection.classList.remove('hidden');
            updateActiveSidebarLink('sidebar-history-button');
             document.body.scrollTop = 0; document.documentElement.scrollTop = 0;
            if (window.innerWidth < 768 && sidebar && !sidebar.classList.contains('translate-x-full')) toggleSidebar();

            const currentUser = auth.currentUser;
            if (!currentUser) {
                historyGrid.innerHTML = '';
                noHistoryMessage.textContent = 'يجب تسجيل الدخول لعرض سجل المشاهدة.';
                noHistoryMessage.classList.remove('hidden');
                loadingHistoryIndicator.classList.add('hidden');
                return;
            }
            historyGrid.innerHTML = '';
            noHistoryMessage.classList.add('hidden');
            loadingHistoryIndicator.classList.remove('hidden');
            try {
                const historySnapshot = await db.collection('watchHistory')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('watchedAt', 'desc')
                    .limit(20)
                    .get();
                if (historySnapshot.empty) {
                    noHistoryMessage.classList.remove('hidden');
                } else {
                    historySnapshot.forEach(doc => {
                        const historyData = doc.data();
                        historyGrid.innerHTML += createVideoCard({
                            id: historyData.videoId,
                            title: historyData.title,
                            thumbnailUrl: historyData.thumbnailUrl,
                            uploaderName: historyData.uploaderName,
                            uploaderId: historyData.uploaderId,
                            uploaderAvatar: historyData.uploaderAvatar,
                            duration: historyData.duration,
                            views: 'السجل',
                            uploadTimestamp: historyData.watchedAt
                        });
                    });
                }
            } catch (error) {
                console.error("Error loading history videos:", error);
                historyGrid.innerHTML = '<p class="col-span-full text-center text-red-500">خطأ في تحميل سجل المشاهدة.</p>';
                if (error.code === 'failed-precondition') historyGrid.innerHTML += '<p class="col-span-full text-center text-orange-500 text-sm">يتطلب فهرسًا على (userId, watchedAt). راجع الكونسول.</p>';
            } finally {
                loadingHistoryIndicator.classList.add('hidden');
            }
        }

        async function loadTrendingVideos() {
            if(!trendingSection || !trendingGrid || !noTrendingMessage || !loadingTrendingIndicator) return;
            hideAllMainSections();
            trendingSection.classList.remove('hidden');
            updateActiveSidebarLink('sidebar-trending-button');
            document.body.scrollTop = 0; document.documentElement.scrollTop = 0;
            if (window.innerWidth < 768 && sidebar && !sidebar.classList.contains('translate-x-full')) toggleSidebar();


            trendingGrid.innerHTML = '';
            noTrendingMessage.classList.add('hidden');
            loadingTrendingIndicator.classList.remove('hidden');
            try {
                const trendingSnapshot = await db.collection('videos')
                    .orderBy('views', 'desc')
                    .limit(12)
                    .get();
                if (trendingSnapshot.empty) {
                    noTrendingMessage.classList.remove('hidden');
                } else {
                    trendingSnapshot.forEach(doc => {
                        trendingGrid.innerHTML += createVideoCard({ id: doc.id, ...doc.data() });
                    });
                }
            } catch (error) {
                console.error("Error loading trending videos:", error);
                trendingGrid.innerHTML = '<p class="col-span-full text-center text-red-500">خطأ في تحميل الفيديوهات الرائجة.</p>';
                 if (error.code === 'failed-precondition') trendingGrid.innerHTML += '<p class="col-span-full text-center text-orange-500 text-sm">يتطلب فهرسًا على (views). راجع الكونسول.</p>';
            } finally {
                loadingTrendingIndicator.classList.add('hidden');
            }
        }

        async function loadStreamsPage() {
            if(!streamsSection || !streamPlaylistItems || !noStreamsAvailable || !streamInfoOverlay) return;
            hideAllMainSections();
            streamsSection.classList.remove('hidden');
            updateActiveSidebarLink('sidebar-streams-button');
            document.body.scrollTop = 0; document.documentElement.scrollTop = 0;
            if (window.innerWidth < 768 && sidebar && !sidebar.classList.contains('translate-x-full')) toggleSidebar();

            streamPlaylistItems.innerHTML = '';
            noStreamsAvailable.classList.add('hidden');
            streamInfoOverlay.classList.add('hidden');

            try {
                const streamsSnapshot = await db.collection('streamPlaylists').orderBy('createdAt', 'desc').get();

                if (streamsSnapshot.empty) {
                    noStreamsAvailable.classList.remove('hidden');
                    noStreamsAvailable.textContent = "لا توجد قوائم بث. قم بإنشاء واحدة!";
                    return;
                }

                let firstPlayableStream = null;
                streamsSnapshot.forEach(doc => {
                    const stream = { id: doc.id, ...doc.data() };
                    if (stream.videoIds && stream.videoIds.length > 0) {
                        const streamItem = document.createElement('div');
                        streamItem.className = 'p-2.5 bg-gray-600 hover:bg-red-500 rounded-md cursor-pointer transition-colors flex justify-between items-center';

                        const streamNameSpan = document.createElement('span');
                        streamNameSpan.textContent = stream.name;
                        streamItem.appendChild(streamNameSpan);

                        const controlsDiv = document.createElement('div');
                        controlsDiv.className = 'space-x-1 space-x-reverse';

                        const editButton = document.createElement('button');
                        editButton.innerHTML = '<span class="material-icons text-sm text-blue-300 hover:text-blue-100">edit</span>';
                        editButton.title = "تعديل قائمة البث";
                        editButton.onclick = (e) => { e.stopPropagation(); openAddStreamPlaylistModal(stream); };
                        controlsDiv.appendChild(editButton);

                        const deleteButton = document.createElement('button');
                        deleteButton.innerHTML = '<span class="material-icons text-sm text-red-300 hover:text-red-100">delete</span>';
                        deleteButton.title = "حذف قائمة البث";
                        deleteButton.onclick = async (e) => { e.stopPropagation(); await deleteStreamPlaylist(stream.id, stream.name); };
                        controlsDiv.appendChild(deleteButton);

                        streamItem.appendChild(controlsDiv);

                        streamItem.dataset.streamId = stream.id;
                        streamItem.onclick = () => startStream(stream.id, stream.name, stream.videoIds);
                        streamPlaylistItems.appendChild(streamItem);

                        if (!firstPlayableStream) firstPlayableStream = stream;
                    }
                });

                if (firstPlayableStream) {
                    startStream(firstPlayableStream.id, firstPlayableStream.name, firstPlayableStream.videoIds);
                } else {
                     noStreamsAvailable.classList.remove('hidden');
                     noStreamsAvailable.textContent = "جميع قوائم البث فارغة حاليًا.";
                }

            } catch (error) {
                console.error("Error loading streams:", error);
                noStreamsAvailable.classList.remove('hidden');
                noStreamsAvailable.textContent = "خطأ في تحميل قوائم البث."
            }
        }

        async function deleteStreamPlaylist(streamId, streamName) {
            if (!confirm(`هل أنت متأكد أنك تريد حذف قائمة البث "${streamName}"؟`)) return;
            try {
                await db.collection('streamPlaylists').doc(streamId).delete();
                alert("تم حذف قائمة البث بنجاح.");
                loadStreamsPage();
                if (currentSelectedStreamId === streamId && streamVideoPlayer) {
                    streamVideoPlayer.pause();
                    streamVideoPlayer.src = "";
                    if(streamInfoOverlay) streamInfoOverlay.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error deleting stream playlist:", error);
                alert("خطأ أثناء حذف قائمة البث.");
            }
        }


        async function startStream(streamId, streamName, videoIds) {
            if (!videoIds || videoIds.length === 0) {
                alert("قائمة التشغيل هذه فارغة.");
                return;
            }
            currentSelectedStreamId = streamId;
            currentStreamPlaylist = videoIds;
            currentStreamVideoIndex = 0;

            if(currentStreamNameElem) currentStreamNameElem.textContent = streamName;
            if(streamInfoOverlay) streamInfoOverlay.classList.remove('hidden');

            if(streamPlaylistItems){
                streamPlaylistItems.querySelectorAll('div[data-stream-id]').forEach(item => {
                    item.classList.remove('bg-red-600', 'text-white', 'font-semibold');
                    item.classList.add('bg-gray-600');
                    if (item.dataset.streamId === streamId) {
                        item.classList.add('bg-red-600', 'text-white', 'font-semibold');
                        item.classList.remove('bg-gray-600');
                    }
                });
            }

            playNextVideoStreamInStream();
        }

        async function playNextVideoStreamInStream() {
            if(!streamVideoPlayer || !currentStreamVideoTitleElem) return;
            if (currentStreamVideoIndex >= currentStreamPlaylist.length) {
                currentStreamVideoIndex = 0;
                if(currentStreamPlaylist.length === 0) {
                    console.log("Stream playlist ended or empty.");
                    streamVideoPlayer.pause();
                    streamVideoPlayer.src = "";
                    currentStreamVideoTitleElem.textContent = "انتهى البث";
                    return;
                }
            }
            const videoIdToPlay = currentStreamPlaylist[currentStreamVideoIndex];
            try {
                const videoDoc = await db.collection('videos').doc(videoIdToPlay).get();
                if (videoDoc.exists) {
                    const videoData = videoDoc.data();
                    streamVideoPlayer.src = videoData.videoUrl;
                    streamVideoPlayer.load();
                    streamVideoPlayer.play().catch(e => console.warn("Stream player error:", e));
                    currentStreamVideoTitleElem.textContent = videoData.title;
                } else {
                    console.warn(`Video ${videoIdToPlay} not found for stream. Skipping.`);
                    currentStreamVideoIndex++;
                    playNextVideoStreamInStream();
                }
            } catch (error) {
                console.error("Error playing video in stream:", error);
                currentStreamVideoIndex++;
                playNextVideoStreamInStream();
            }
        }

        function startAutoplayCountdown() {
            const currentVideoPlayerElement = document.getElementById('current-video-player');
            if (autoplayTimer) clearTimeout(autoplayTimer);
            // Do not start autoplay if video is live or looping
            if (isLiveStreamPlaying() || (currentVideoPlayerElement && currentVideoPlayerElement.loop)) {
                if(autoplayOverlay) autoplayOverlay.classList.add('hidden');
                return;
            }

            if (isAutoplayCancelledManually || !autoplayOverlay || !autoplayNextTitle || !autoplayNextThumbnail || !autoplayCountdown) {
                 if(autoplayOverlay) autoplayOverlay.classList.add('hidden');
                 return;
            }

            const nextVideoFromCache = suggestedVideosCache.length > 0 ? suggestedVideosCache[0] : null;

            if (nextVideoFromCache) {
                nextAutoplayVideoId = nextVideoFromCache.id;
                autoplayNextTitle.textContent = nextVideoFromCache.title;
                autoplayNextThumbnail.src = nextVideoFromCache.thumbnailUrl || 'https://via.placeholder.com/120x68';
            } else {
                console.log("No next video for autoplay from cache.");
                autoplayOverlay.classList.add('hidden');
                return;
            }

            autoplayCountdownValue = AUTOPLAY_DEFAULT_COUNTDOWN;
            autoplayCountdown.textContent = autoplayCountdownValue;
            autoplayOverlay.classList.remove('hidden');

            autoplayTimer = setInterval(() => {
                autoplayCountdownValue--;
                autoplayCountdown.textContent = autoplayCountdownValue;
                if (autoplayCountdownValue <= 0) {
                    clearInterval(autoplayTimer);
                    autoplayTimer = null;
                    if (nextAutoplayVideoId) {
                        showVideoPlayer(nextAutoplayVideoId);
                    }
                    autoplayOverlay.classList.add('hidden');
                }
            }, 1000);
        }
        function isLiveStreamPlaying() {
            // Check if the video source is an HLS URL (typical for live streams via AMS)
            // And also if the videoPlayerSection is for a live stream (not a VOD)
            const currentVideoPlayerElement = document.getElementById('current-video-player');
            return videoJsPlayer && currentVideoPlayerElement && currentVideoPlayerElement.currentSrc && currentVideoPlayerElement.currentSrc.includes('.m3u8');
        }


        function openUploadModalHandler() {
            if (auth.currentUser) {
                uploadVideoModal.classList.remove('hidden');
                uploadVideoForm.reset();
                isStreamsyOriginalCheckbox.checked = false;
                uploadStatus.textContent = '';
                uploadProgressBarContainer.classList.add('hidden');
                uploadProgressBar.style.width = '0%';
                uploadProgressText.textContent = '0%';
                submitUploadButton.disabled = false;
                submitUploadButton.classList.remove('opacity-50', 'cursor-not-allowed');
                bodyElement.classList.add('body-no-scroll');
            } else {
                showAuthModal(true);
                alert('يجب تسجيل الدخول لرفع فيديو.');
            }
        }
        function closeUploadModalHandler() {
            uploadVideoModal.classList.add('hidden');
            bodyElement.classList.remove('body-no-scroll');
        }

        function openEditChannelModal() {
            const user = auth.currentUser;
            if (!user || !editChannelModal || !editChannelNameInput) return;

            db.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    editChannelNameInput.value = userData.displayName || user.displayName || '';
                    if(editChannelDescriptionInput) editChannelDescriptionInput.value = userData.channelDescription || '';
                    if (editChannelProfilePreview && (userData.photoURL || user.photoURL)) {
                        editChannelProfilePreview.src = userData.photoURL || user.photoURL;
                        editChannelProfilePreview.classList.remove('hidden');
                    } else if (editChannelProfilePreview) { editChannelProfilePreview.classList.add('hidden'); }
                    if (editChannelCoverPreview && userData.channelCoverUrl) {
                        editChannelCoverPreview.src = userData.channelCoverUrl;
                        editChannelCoverPreview.classList.remove('hidden');
                    } else if(editChannelCoverPreview) { editChannelCoverPreview.classList.add('hidden'); }
                } else {
                     editChannelNameInput.value = user.displayName || (user.email ? user.email.split('@')[0] : "مستخدم");
                     if(editChannelDescriptionInput) editChannelDescriptionInput.value = '';
                     if (editChannelProfilePreview && user.photoURL) {
                        editChannelProfilePreview.src = user.photoURL;
                        editChannelProfilePreview.classList.remove('hidden');
                    } else if (editChannelProfilePreview) { editChannelProfilePreview.classList.add('hidden'); }
                    if(editChannelCoverPreview) editChannelCoverPreview.classList.add('hidden');
                }
                if(editChannelStatus) editChannelStatus.textContent = '';
                editChannelModal.classList.remove('hidden');
                bodyElement.classList.add('body-no-scroll');
            }).catch(error => {
                console.error("Error fetching user data for edit modal:", error);
                alert("خطأ في تحميل بيانات القناة للتعديل.");
            });
        }
        function closeEditChannelModalHandler() {
            if(editChannelModal) editChannelModal.classList.add('hidden');
            bodyElement.classList.remove('body-no-scroll');
        }
        function openEditVideoModal() {
            if(editVideoModal) editVideoModal.classList.remove('hidden');
            bodyElement.classList.add('body-no-scroll');
        }
        function closeEditVideoModalHandler() {
            if(editVideoModal) editVideoModal.classList.add('hidden');
            bodyElement.classList.remove('body-no-scroll');
        }

        function showStudioInfoModal() {
            if(studioInfoModal) studioInfoModal.classList.remove('hidden');
            bodyElement.classList.add('body-no-scroll');
            setupLiveStreamStudio(); // Setup info when modal opens
        }
        function hideStudioInfoModal() {
            if(studioInfoModal) studioInfoModal.classList.add('hidden');
            bodyElement.classList.remove('body-no-scroll');
            if (screenSharePreview && screenSharePreview.srcObject) {
                screenSharePreview.srcObject.getTracks().forEach(track => track.stop());
                screenSharePreview.srcObject = null;
                screenSharePreview.classList.add('hidden');
            }
        }

        function openAddStreamPlaylistModal(streamToEdit = null) {
            if (!addStreamPlaylistModal || !addStreamPlaylistForm || !editingStreamPlaylistIdInput || !streamPlaylistNameInput || !streamPlaylistVideoIdsInput) return;
            addStreamPlaylistForm.reset();
            if (streamToEdit) {
                editingStreamPlaylistIdInput.value = streamToEdit.id;
                streamPlaylistNameInput.value = streamToEdit.name;
                streamPlaylistVideoIdsInput.value = streamToEdit.videoIds ? streamToEdit.videoIds.join(',') : '';
                if(submitAddStreamPlaylistButton) submitAddStreamPlaylistButton.textContent = "تحديث قائمة البث";
            } else {
                editingStreamPlaylistIdInput.value = '';
                if(submitAddStreamPlaylistButton) submitAddStreamPlaylistButton.textContent = "إنشاء قائمة البث";
            }
            addStreamPlaylistModal.classList.remove('hidden');
            bodyElement.classList.add('body-no-scroll');
        }

        function closeAddStreamPlaylistModal() {
            if(addStreamPlaylistModal) addStreamPlaylistModal.classList.add('hidden');
            bodyElement.classList.remove('body-no-scroll');
        }

        async function deleteVideo(videoId, videoUrl, thumbnailUrl, videoTitle) {
            const user = auth.currentUser;
            if (!user) {
                alert("يجب تسجيل الدخول لحذف الفيديو.");
                return false;
            }

            // Fetch the video data to confirm ownership if currentVideoDataForPlayer is not set for this video
            let isOwner = false;
            if (currentVideoDataForPlayer && currentVideoDataForPlayer.id === videoId) {
                isOwner = currentVideoDataForPlayer.uploaderId === user.uid;
            } else {
                const videoDoc = await db.collection('videos').doc(videoId).get();
                if (videoDoc.exists && videoDoc.data().uploaderId === user.uid) {
                    isOwner = true;
                    // Use fetched data if currentVideoDataForPlayer wasn't for this video
                    videoUrl = videoUrl || videoDoc.data().videoUrl;
                    thumbnailUrl = thumbnailUrl || videoDoc.data().thumbnailUrl;
                    videoTitle = videoTitle || videoDoc.data().title;
                }
            }

            if (!isOwner) {
                alert("لا يمكنك حذف هذا الفيديو لأنه لا ينتمي إليك.");
                return false;
            }


            if (confirm(`هل أنت متأكد أنك تريد حذف "${videoTitle || 'هذا الفيديو'}"؟ لا يمكن التراجع عن هذا الإجراء.`)) {
                try {
                    await db.collection('videos').doc(videoId).delete();
                    if (videoUrl && videoUrl.startsWith("https://firebasestorage.googleapis.com")) {
                        await storage.refFromURL(videoUrl).delete().catch(err => console.warn("Error deleting video file:", err));
                    }
                    if (thumbnailUrl && thumbnailUrl.startsWith("https://firebasestorage.googleapis.com")) {
                        await storage.refFromURL(thumbnailUrl).delete().catch(err => console.warn("Error deleting thumbnail file:", err));
                    }

                    const batch = db.batch();
                    const likesToDelete = await db.collection('likes').where('videoId', '==', videoId).get();
                    likesToDelete.forEach(doc => batch.delete(doc.ref));
                    const commentsToDelete = await db.collection('comments').where('videoId', '==', videoId).get();
                    commentsToDelete.forEach(doc => batch.delete(doc.ref));
                    const historyToDelete = await db.collection('watchHistory').where('videoId', '==', videoId).get();
                    historyToDelete.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();


                    alert('تم حذف الفيديو بنجاح.');
                    return true;
                } catch (error) {
                    console.error("Error deleting video:", error);
                    alert('خطأ أثناء حذف الفيديو.');
                    return false;
                }
            }
            return false;
        }


        function setupEventListeners() {
            if(logoHomeButton) logoHomeButton.addEventListener('click', (e) => { e.preventDefault(); navigateToHomeView(false, true); });
            if(menuButton) menuButton.addEventListener('click', toggleSidebar);
            if(sidebarOverlay) sidebarOverlay.addEventListener('click', toggleSidebar);
            if(searchInput && searchInput.form) searchInput.form.addEventListener('submit', (e) => { e.preventDefault(); handleSearch(); });
            if(notificationsButton) notificationsButton.addEventListener('click', () => alert('ميزة الإشعارات قيد التطوير!'));
            if(studioLink) studioLink.addEventListener('click', (e) => { e.preventDefault(); showStudioInfoModal(); });
            if(closeStudioInfoModalButton) closeStudioInfoModalButton.addEventListener('click', hideStudioInfoModal);
            if(okStudioInfoModalButton) okStudioInfoModalButton.addEventListener('click', hideStudioInfoModal);
            if(goToStreamsFromModalLink) goToStreamsFromModalLink.addEventListener('click', (e) => {
                e.preventDefault();
                hideStudioInfoModal();
                loadStreamsPage();
            });


            if(closeAuthModalButton) closeAuthModalButton.addEventListener('click', hideAuthModal);
            if(authModal) authModal.addEventListener('click', (e) => { if (e.target === authModal) hideAuthModal(); });
            if(authSwitchButton) authSwitchButton.addEventListener('click', (e) => { e.preventDefault(); showAuthModal(!isLoginMode); });
            if(authForm) authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = authEmailInput.value;
                const password = authPasswordInput.value;
                authError.classList.add('hidden'); authError.textContent = '';
                const actionPromise = isLoginMode ? auth.signInWithEmailAndPassword(email, password) : auth.createUserWithEmailAndPassword(email, password);
                actionPromise.catch(err => {
                    console.error("Auth Error:", err.code, err.message);
                    let message = "حدث خطأ ما.";
                    if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') message = "البريد الإلكتروني أو كلمة المرور غير صحيحة.";
                    else if (err.code === 'auth/email-already-in-use') message = "هذا البريد الإلكتروني مستخدم بالفعل.";
                    else if (err.code === 'auth/weak-password') message = "كلمة المرور ضعيفة جداً (6 أحرف على الأقل).";
                    authError.textContent = message; authError.classList.remove('hidden');
                });
            });

             window.addEventListener('click', (event) => {
                const userMenuButtonInternal = document.getElementById('user-menu-button');
                if (userMenuButtonInternal && userDropdown && !userDropdown.classList.contains('hidden') && !userDropdown.contains(event.target) && !userMenuButtonInternal.contains(event.target)) {
                    userDropdown.classList.add('hidden');
                }
                if (qualityOptionsDropdown && !qualityOptionsDropdown.classList.contains('hidden') && qualityMenuButton && !qualityMenuButton.contains(event.target) && !qualityOptionsDropdown.contains(event.target) ) {
                    qualityOptionsDropdown.classList.add('hidden');
                }
                if (videoOptionsDropdown && !videoOptionsDropdown.classList.contains('hidden') && moreVideoOptionsButton && !moreVideoOptionsButton.contains(event.target) && !videoOptionsDropdown.contains(event.target) ) {
                    videoOptionsDropdown.classList.add('hidden');
                }
            });
            if(signOutButton) signOutButton.addEventListener('click', (e) => { e.preventDefault(); auth.signOut(); if (userDropdown) userDropdown.classList.add('hidden'); navigateToHomeView(false, true); });
            if(dropdownUserProfileLink) dropdownUserProfileLink.addEventListener('click', (e) => { e.preventDefault(); if(auth.currentUser) showChannelPageInternal(auth.currentUser.uid); });

            if(sidebarHomeButton) sidebarHomeButton.addEventListener('click', (e) => { e.preventDefault(); navigateToHomeView(false, true); });
            if(sidebarYourChannelButton) sidebarYourChannelButton.addEventListener('click', (e) => { e.preventDefault(); if(auth.currentUser) showChannelPageInternal(auth.currentUser.uid); else showAuthModal(true); });
            if(yourChannelLink) yourChannelLink.addEventListener('click', (e) => { e.preventDefault(); if(auth.currentUser) showChannelPageInternal(auth.currentUser.uid); else showAuthModal(true); });
            if (sidebarShortsButton) { sidebarShortsButton.addEventListener('click', (e) => { e.preventDefault(); hideAllMainSections(); if(shortsSection) shortsSection.classList.remove('hidden'); updateActiveSidebarLink('sidebar-shorts-button'); document.body.scrollTop = 0; document.documentElement.scrollTop = 0; if (window.innerWidth < 768 && sidebar && !sidebar.classList.contains('translate-x-full')) toggleSidebar(); }); }
            if (closeShortsButton) closeShortsButton.addEventListener('click', () => navigateToHomeView(false, true));
            if (sidebarSubscriptionsButton) { sidebarSubscriptionsButton.addEventListener('click', (e) => { e.preventDefault(); hideAllMainSections(); if(subscriptionsSection) subscriptionsSection.classList.remove('hidden'); updateActiveSidebarLink('sidebar-subscriptions-button'); document.body.scrollTop = 0; document.documentElement.scrollTop = 0; if (window.innerWidth < 768 && sidebar && !sidebar.classList.contains('translate-x-full')) toggleSidebar(); loadSubscribedChannelsVideos(); }); }
            if (sidebarLiveStreamsButton) {
                sidebarLiveStreamsButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    hideAllMainSections();
                    if (liveNowSection) liveNowSection.classList.remove('hidden'); // Show the list of live streams
                    updateActiveSidebarLink('sidebar-live-streams-button');
                    loadLiveNowStreams();
                });
            }

            if(sidebarHistoryButton) sidebarHistoryButton.addEventListener('click', (e) => { e.preventDefault(); loadHistoryVideos(); });
            if(sidebarLikedVideosButton) sidebarLikedVideosButton.addEventListener('click', (e) => { e.preventDefault(); loadLikedVideos(); });
            if(sidebarTrendingButton) sidebarTrendingButton.addEventListener('click', (e) => { e.preventDefault(); loadTrendingVideos(); });
            if(sidebarStreamsButton) sidebarStreamsButton.addEventListener('click', (e) => {e.preventDefault(); loadStreamsPage(); });

            if(addNewStreamPlaylistButton) addNewStreamPlaylistButton.addEventListener('click', () => openAddStreamPlaylistModal());
            if(closeAddStreamPlaylistModalButton) closeAddStreamPlaylistModalButton.addEventListener('click', closeAddStreamPlaylistModal);
            if(addStreamPlaylistForm) addStreamPlaylistForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const playlistName = streamPlaylistNameInput.value.trim();
                const videoIdsString = streamPlaylistVideoIdsInput.value.trim();
                const editingId = editingStreamPlaylistIdInput.value;

                if (!playlistName || !videoIdsString) {
                    alert("يرجى ملء اسم القائمة ومعرفات الفيديوهات.");
                    return;
                }
                const videoIdsArray = videoIdsString.split(',').map(id => id.trim()).filter(id => id);
                if (videoIdsArray.length === 0) {
                    alert("يرجى إدخال معرف فيديو واحد على الأقل.");
                    return;
                }

                const user = auth.currentUser;
                if (!user) { alert("يجب تسجيل الدخول لإنشاء قائمة بث."); return; }

                const playlistData = {
                    name: playlistName,
                    videoIds: videoIdsArray,
                    ownerId: user.uid,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    if (editingId) {
                        await db.collection('streamPlaylists').doc(editingId).update(playlistData);
                        alert("تم تحديث قائمة البث بنجاح!");
                    } else {
                        playlistData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await db.collection('streamPlaylists').add(playlistData);
                        alert("تم إنشاء قائمة البث بنجاح!");
                    }
                    closeAddStreamPlaylistModal();
                    loadStreamsPage();
                } catch (error) {
                    console.error("Error saving stream playlist:", error);
                    alert("خطأ أثناء حفظ قائمة البث.");
                }
            });

            if (startScreenShareButton && screenSharePreview) {
                startScreenShareButton.addEventListener('click', async () => {
                    if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                        try {
                            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                            screenSharePreview.srcObject = stream;
                            screenSharePreview.classList.remove('hidden');
                            screenSharePreview.onloadedmetadata = () => screenSharePreview.play();
                            stream.getVideoTracks()[0].onended = () => {
                                screenSharePreview.classList.add('hidden');
                                screenSharePreview.srcObject = null;
                            };
                        } catch (err) {
                            console.error("Error starting screen share:", err);
                            alert("فشل بدء بث الشاشة. تأكد من منح الإذن.");
                            screenSharePreview.classList.add('hidden');
                        }
                    } else {
                        alert("متصفحك لا يدعم بث الشاشة.");
                    }
                });
            }


            if(openUploadModalButtonHeader) openUploadModalButtonHeader.addEventListener('click', openUploadModalHandler);
            if(openUploadModalButtonSidebar) openUploadModalButtonSidebar.addEventListener('click', openUploadModalHandler);
            if(closeUploadModalBtn) closeUploadModalBtn.addEventListener('click', closeUploadModalHandler);
            if (uploadFromNoVideosLink) uploadFromNoVideosLink.addEventListener('click', (e) => { e.preventDefault(); openUploadModalHandler(); });
            if (uploadFromChannelPageLink) uploadFromChannelPageLink.addEventListener('click', (e) => { e.preventDefault(); openUploadModalHandler(); });

            if(uploadVideoForm) uploadVideoForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) { uploadStatus.textContent = 'خطأ: يجب تسجيل الدخول.'; return; }

                const title = videoTitleInput.value.trim();
                const description = videoDescriptionInput.value.trim();
                const category = videoCategoryInput.value;
                const isOriginal = isStreamsyOriginalCheckbox.checked;
                const tagsInputVal = videoTagsInput.value.trim();
                const tags = tagsInputVal ? tagsInputVal.split(',').map(tag => tag.trim().replace(/^#/, '')).filter(tag => tag !== '') : [];

                const videoFile = videoFileInput.files[0];
                let thumbnailFile = thumbnailFileInput.files[0];

                if (!title || !videoFile) {
                    uploadStatus.textContent = 'يرجى ملء العنوان واختيار ملف الفيديو.';
                    return;
                }

                submitUploadButton.disabled = true; submitUploadButton.classList.add('opacity-50', 'cursor-not-allowed');
                uploadStatus.textContent = 'جارٍ الرفع والتحضير...'; uploadProgressBarContainer.classList.remove('hidden');

                try {
                    const timestamp = Date.now();
                    const videoFileName = `${user.uid}_${timestamp}_${videoFile.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                    const videoRef = storage.ref(`videos/${user.uid}/${videoFileName}`);

                    const videoUploadTask = videoRef.put(videoFile);

                    videoUploadTask.on('state_changed', (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        uploadProgressBar.style.width = progress + '%';
                        uploadProgressText.textContent = `${Math.round(progress)}%`;
                        uploadStatus.textContent = `رفع الفيديو: ${Math.round(progress)}%`;
                    },
                    (error) => {
                        console.error("Video upload error:", error);
                        uploadStatus.textContent = `فشل رفع الفيديو: ${error.message}`;
                        submitUploadButton.disabled = false;
                        submitUploadButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    },
                    async () => {
                        uploadStatus.textContent = 'الفيديو رُفع، جارٍ معالجة الصورة المصغرة...';
                        const videoUrl = await videoUploadTask.snapshot.ref.getDownloadURL();
                        let thumbnailUrl = '';
                        const videoUrls = { default: videoUrl };

                        const generateThumbnailFromVideo = (videoFileSrc, seekToTime = 1.0) => {
                            return new Promise((resolve, reject) => {
                                const videoPlayerForThumb = document.createElement('video');
                                videoPlayerForThumb.setAttribute('src', URL.createObjectURL(videoFileSrc));
                                videoPlayerForThumb.load();
                                videoPlayerForThumb.addEventListener('error', (ex) => reject("خطأ في تحميل الفيديو لإنشاء الصورة المصغرة."));

                                videoPlayerForThumb.addEventListener('loadedmetadata', () => {
                                    videoPlayerForThumb.currentTime = Math.min(Math.max(0, seekToTime), videoPlayerForThumb.duration);
                                });

                                videoPlayerForThumb.addEventListener('seeked', () => {
                                    const canvas = document.createElement('canvas');
                                    canvas.width = videoPlayerForThumb.videoWidth;
                                    canvas.height = videoPlayerForThumb.videoHeight;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(videoPlayerForThumb, 0, 0, canvas.width, canvas.height);
                                    URL.revokeObjectURL(videoPlayerForThumb.getAttribute('src'));

                                    canvas.toBlob(blob => {
                                        if (!blob) {
                                            reject("فشل إنشاء Blob من الكانفاس.");
                                            return;
                                        }
                                        resolve(new File([blob], `thumbnail_${timestamp}.jpg`, { type: 'image/jpeg', lastModified: Date.now() }));
                                    }, 'image/jpeg', 0.85);
                                });
                            });
                        };

                        if (!thumbnailFile && videoFile) {
                            uploadStatus.textContent = 'جارٍ إنشاء صورة مصغرة تلقائيًا...';
                            try {
                                thumbnailFile = await generateThumbnailFromVideo(videoFile);
                                console.log("Thumbnail generated automatically:", thumbnailFile.name);
                            } catch (thumbError) {
                                console.error("Error generating thumbnail automatically:", thumbError);
                                uploadStatus.textContent = `فشل إنشاء الصورة المصغرة تلقائيًا: ${thumbError}. سيتم الرفع بدون صورة مصغرة مخصصة.`;
                            }
                        }

                        if (thumbnailFile) {
                            uploadStatus.textContent = 'جارٍ رفع الصورة المصغرة...';
                            const thumbnailFileName = `${user.uid}_${timestamp}_${thumbnailFile.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                            const thumbnailStorageRef = storage.ref(`thumbnails/${user.uid}/${thumbnailFileName}`);
                            const thumbnailUploadTask = thumbnailStorageRef.put(thumbnailFile);

                            thumbnailUploadTask.on('state_changed', null,
                            (error) => {
                                console.error("Thumbnail upload error:", error);
                                uploadStatus.textContent = `فشل رفع الصورة المصغرة: ${error.message}`;
                                saveVideoData(videoUrl, '', title, description, category, tags, isOriginal, user, timestamp, videoUrls);
                            },
                            async () => {
                                thumbnailUrl = await thumbnailUploadTask.snapshot.ref.getDownloadURL();
                                saveVideoData(videoUrl, thumbnailUrl, title, description, category, tags, isOriginal, user, timestamp, videoUrls);
                            });
                        } else {
                            saveVideoData(videoUrl, '', title, description, category, tags, isOriginal, user, timestamp, videoUrls);
                        }
                    });
                } catch (error) {
                    console.error("Upload process error:", error);
                    uploadStatus.textContent = `خطأ عام في الرفع: ${error.message}`;
                    submitUploadButton.disabled = false;
                    submitUploadButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });

            async function saveVideoData(videoUrl, thumbnailUrl, title, description, category, tags, isOriginal, user, timestamp, videoUrlsMap) {
                uploadStatus.textContent = 'جارٍ حفظ بيانات الفيديو...';
                let durationString = "0:00";
                const tempVideo = document.createElement('video');
                tempVideo.src = videoUrl;

                const saveToDb = (finalDuration) => {
                    db.collection('videos').add({
                        title, description, videoUrl, videoUrls: videoUrlsMap || { default: videoUrl }, thumbnailUrl,
                        category: category || null, tags,
                        uploaderId: user.uid,
                        uploaderName: user.displayName || (user.email ? user.email.split('@')[0] : "مستخدم"),
                        uploaderAvatar: user.photoURL || `https://ui-avatars.com/api/?name=${(user.email || 'U').charAt(0).toUpperCase()}&background=random&size=48&color=fff&font-size=0.4`,
                        uploadTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        views: 0, likes: 0, dislikes: 0,
                        duration: finalDuration,
                        title_lowercase: title.toLowerCase(),
                        isStreamsyOriginal: isOriginal
                    }).then(async () => {
                        await updateUserInteractionPoints(user.uid, INTERACTION_POINTS.UPLOAD_VIDEO);
                        uploadStatus.textContent = 'تم رفع الفيديو بنجاح!';
                        uploadVideoForm.reset();
                        setTimeout(() => {
                            closeUploadModalHandler();
                            submitUploadButton.disabled = false;
                            submitUploadButton.classList.remove('opacity-50', 'cursor-not-allowed');
                            uploadProgressBarContainer.classList.add('hidden');
                        }, 2000);
                        navigateToHomeView(false, true);
                    }).catch(dbError => {
                        console.error("Error saving video data to Firestore:", dbError);
                        uploadStatus.textContent = `فشل حفظ بيانات الفيديو: ${dbError.message}`;
                        submitUploadButton.disabled = false;
                        submitUploadButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    });
                };

                tempVideo.onloadedmetadata = () => {
                    const d = Math.round(tempVideo.duration);
                    if (isFinite(d) && d > 0) {
                        const minutes = Math.floor(d / 60);
                        const seconds = d % 60;
                        durationString = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                    } else {
                        durationString = "N/A";
                    }
                    saveToDb(durationString);
                };
                tempVideo.onerror = () => {
                     console.warn("Could not load video metadata to get duration.");
                     saveToDb("N/A");
                };
            }

            document.getElementById('main-content-wrapper').addEventListener('click', (e) => {
                const clickableChannel = e.target.closest('.channel-name-clickable[data-channel-id]');
                if (clickableChannel && clickableChannel.dataset.channelId) {
                    e.preventDefault();
                    e.stopPropagation();
                    showChannelPageInternal(clickableChannel.dataset.channelId);
                }
            });


            if(videoGrid) videoGrid.addEventListener('click', (e) => { const card = e.target.closest('.video-card-wrapper[data-video-id]'); if (card && card.dataset.videoId) showVideoPlayer(card.dataset.videoId); });
            if(subscriptionsGrid) subscriptionsGrid.addEventListener('click', (e) => { const card = e.target.closest('.video-card-wrapper[data-video-id]'); if (card && card.dataset.videoId) showVideoPlayer(card.dataset.videoId); });
            if(likedVideosGrid) likedVideosGrid.addEventListener('click', (e) => { const card = e.target.closest('.video-card-wrapper[data-video-id]'); if (card && card.dataset.videoId) showVideoPlayer(card.dataset.videoId); });
            if(historyGrid) historyGrid.addEventListener('click', (e) => { const card = e.target.closest('.video-card-wrapper[data-video-id]'); if (card && card.dataset.videoId) showVideoPlayer(card.dataset.videoId); });
            if(trendingGrid) trendingGrid.addEventListener('click', (e) => { const card = e.target.closest('.video-card-wrapper[data-video-id]'); if (card && card.dataset.videoId) showVideoPlayer(card.dataset.videoId); });
            if(liveNowGrid) liveNowGrid.addEventListener('click', (e) => { // NEW: Click listener for live stream cards
                const card = e.target.closest('.video-card-wrapper[data-video-id]'); // Assuming live cards also have this structure
                if (card && card.dataset.videoId) {
                    // We need to fetch the HLS URL for this live stream
                    db.collection("liveStreams").doc(card.dataset.videoId).get().then(docSnap => {
                        if (docSnap.exists() && docSnap.data().isLive) {
                            const liveData = docSnap.data();
                            playLiveStream(card.dataset.videoId, liveData.hlsUrl, liveData.title);
                        } else {
                            alert("هذا البث المباشر لم يعد متاحًا.");
                            loadLiveNowStreams(); // Refresh list
                        }
                    }).catch(err => {
                        console.error("Error fetching live stream details on click:", err);
                        alert("خطأ في الوصول إلى تفاصيل البث المباشر.");
                    });
                }
            });


            if (qualityMenuButton) { qualityMenuButton.addEventListener('click', (e) => { e.stopPropagation(); if(qualityOptionsDropdown) qualityOptionsDropdown.classList.toggle('hidden'); }); }
            if (loopVideoButton) {
                loopVideoButton.addEventListener('click', () => {
                    const currentVideoPlayerElement = document.getElementById('current-video-player');
                    if (currentVideoPlayerElement) {
                        currentVideoPlayerElement.loop = !currentVideoPlayerElement.loop;
                        loopVideoButton.classList.toggle('action-button-active', currentVideoPlayerElement.loop);
                        const icon = loopVideoButton.querySelector('.material-icons-outlined');
                        if (icon) icon.textContent = currentVideoPlayerElement.loop ? 'repeat_one' : 'loop';
                        if (currentVideoPlayerElement.loop && currentVideoPlayerElement.ended) currentVideoPlayerElement.play();
                    }
                });
            }
            if (moreVideoOptionsButton && videoOptionsDropdown) {
                moreVideoOptionsButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    videoOptionsDropdown.classList.toggle('hidden');
                });
            }
            if (editCurrentVideoButton) {
                editCurrentVideoButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentVideoDataForPlayer) {
                        editVideoIdInput.value = currentVideoDataForPlayer.id;
                        editVideoTitleInput.value = currentVideoDataForPlayer.title;
                        editVideoDescriptionInput.value = currentVideoDataForPlayer.description || '';
                        editVideoCategoryInput.value = currentVideoDataForPlayer.category || '';
                        editVideoTagsInput.value = currentVideoDataForPlayer.tags ? currentVideoDataForPlayer.tags.join(',') : '';
                        editIsStreamsyOriginalCheckbox.checked = currentVideoDataForPlayer.isStreamsyOriginal || false;
                        openEditVideoModal();
                        if (videoOptionsDropdown) videoOptionsDropdown.classList.add('hidden');
                    }
                });
            }
            if (deleteCurrentVideoButton) {
                deleteCurrentVideoButton.addEventListener('click', async (e) => {
                    e.preventDefault();
                    if (currentVideoDataForPlayer) {
                        const deleted = await deleteVideo(currentVideoDataForPlayer.id, currentVideoDataForPlayer.videoUrl, currentVideoDataForPlayer.thumbnailUrl, currentVideoDataForPlayer.title);
                        if (deleted) {
                            navigateToHomeView(false, true);
                        }
                        if (videoOptionsDropdown) videoOptionsDropdown.classList.add('hidden');
                    }
                });
            }


            if (playerToggleDescriptionButton) { playerToggleDescriptionButton.addEventListener('click', () => { isPlayerDescriptionExpanded = !isPlayerDescriptionExpanded; playerDescriptionSnippet.classList.toggle('hidden', isPlayerDescriptionExpanded); playerDescriptionSnippet.classList.toggle('line-clamp-3', !isPlayerDescriptionExpanded); playerDescriptionFull.classList.toggle('hidden', !isPlayerDescriptionExpanded); playerToggleDescriptionButton.textContent = isPlayerDescriptionExpanded ? "عرض أقل" : "عرض المزيد"; }); }
            if (suggestedVideosAside) suggestedVideosAside.addEventListener('click', handleSuggestedVideoClick);
            if (suggestedVideosMobileContainer) suggestedVideosMobileContainer.addEventListener('click', handleSuggestedVideoClick);
            if(playerAddCommentForm) playerAddCommentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) { alert('يجب تسجيل الدخول للتعليق.'); showAuthModal(true); return; }
                if (!currentVideoIdForPlayer || !currentVideoDataForPlayer) return;
                const text = playerCommentTextInput.value.trim();
                if (text === '') return;
                try {
                    await db.collection('comments').add({ videoId: currentVideoIdForPlayer, userId: user.uid, userName: user.displayName || (user.email ? user.email.split('@')[0] : "مستخدم"), userAvatar: user.photoURL || `https://ui-avatars.com/api/?name=${(user.email || 'U').charAt(0).toUpperCase()}&background=random&size=36&color=fff&font-size=0.5`, text: text, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    playerCommentTextInput.value = '';
                    await updateUserInteractionPoints(user.uid, INTERACTION_POINTS.COMMENT);
                    if (currentVideoDataForPlayer.uploaderId && currentVideoDataForPlayer.uploaderId !== user.uid) {
                        await updateUserInteractionPoints(currentVideoDataForPlayer.uploaderId, INTERACTION_POINTS.COMMENT);
                    }
                } catch (error) { console.error("Error adding comment:", error); alert('فشل إضافة التعليق.');}
            });
            if(playerLikeButton) playerLikeButton.addEventListener('click', () => { if (currentVideoDataForPlayer && !isLiveStreamPlaying()) handleLikeDislike('like', currentVideoIdForPlayer, currentVideoDataForPlayer.uploaderId); });
            if(playerDislikeButton) playerDislikeButton.addEventListener('click', () => { if (currentVideoDataForPlayer && !isLiveStreamPlaying()) handleLikeDislike('dislike', currentVideoIdForPlayer, currentVideoDataForPlayer.uploaderId); });
            if(playerShareButton) playerShareButton.addEventListener('click', () => {
                if (currentVideoIdForPlayer) {
                    const videoUrl = `${window.location.origin}${window.location.pathname}?videoId=${currentVideoIdForPlayer}`;
                    navigator.clipboard.writeText(videoUrl)
                        .then(() => alert('تم نسخ رابط الفيديو! يمكنك الآن مشاركته.'))
                        .catch(err => { console.error('Failed to copy URL: ', err); alert('فشل نسخ الرابط.'); });
                }
            });
            if(playerSaveButton) playerSaveButton.addEventListener('click', () => alert('ميزة "حفظ الفيديو" لقوائم التشغيل قيد التطوير!'));
            if(playerChannelInfoClickable) playerChannelInfoClickable.addEventListener('click', () => {
                if (currentChannelIdForPlayer) {
                    showChannelPageInternal(currentChannelIdForPlayer);
                }
            });

            const currentVideoPlayerElement = document.getElementById('current-video-player');
            if (currentVideoPlayerElement) {
                currentVideoPlayerElement.onended = () => {
                    if (!currentVideoPlayerElement.loop && !isAutoplayCancelledManually && !isLiveStreamPlaying()) {
                        startAutoplayCountdown();
                    } else if (currentVideoPlayerElement.loop) {
                        console.log("Video ended and is set to loop.");
                    }
                };
            }
            if (autoplayCancelButton) autoplayCancelButton.addEventListener('click', () => {
                if (autoplayTimer) clearTimeout(autoplayTimer);
                if (autoplayOverlay) autoplayOverlay.classList.add('hidden');
                isAutoplayCancelledManually = true;
            });
            if (autoplayPlayNowButton) autoplayPlayNowButton.addEventListener('click', () => {
                if (autoplayTimer) clearTimeout(autoplayTimer);
                if (autoplayOverlay) autoplayOverlay.classList.add('hidden');
                if (nextAutoplayVideoId) {
                    showVideoPlayer(nextAutoplayVideoId);
                }
            });

            if (streamVideoPlayer) {
                streamVideoPlayer.onended = () => {
                    currentStreamVideoIndex++;
                    playNextVideoStreamInStream();
                };
            }

            if(categoriesBar) categoriesBar.addEventListener('click', (e) => { const button = e.target.closest('.category-button'); if (button) { categoriesBar.querySelectorAll('.category-button').forEach(btn => { btn.classList.remove('active'); }); button.classList.add('active'); filterVideosByCategory(button.dataset.category); } });

            if(myVideosGrid) myVideosGrid.addEventListener('click', async (e) => {
                const user = auth.currentUser;
                if (!user) return;
                const editButton = e.target.closest('.edit-my-video-btn');
                const deleteButton = e.target.closest('.delete-my-video-btn');

                if (editButton) {
                    e.stopPropagation();
                    editVideoIdInput.value = editButton.dataset.videoId;
                    editVideoTitleInput.value = unescape(editButton.dataset.title);
                    editVideoDescriptionInput.value = unescape(editButton.dataset.description);
                    editVideoCategoryInput.value = editButton.dataset.category;
                    editVideoTagsInput.value = editButton.dataset.tags;
                    editIsStreamsyOriginalCheckbox.checked = editButton.dataset.isOriginal === 'true';
                    openEditVideoModal();
                } else if (deleteButton) {
                    e.stopPropagation();
                    const videoId = deleteButton.dataset.videoId;
                    const videoUrl = deleteButton.dataset.videoUrl;
                    const thumbnailUrl = deleteButton.dataset.thumbnailUrl;
                    const videoTitleElement = deleteButton.closest('.group').querySelector('h3');
                    const videoTitle = videoTitleElement ? unescape(videoTitleElement.textContent) : "هذا الفيديو";

                    const deleted = await deleteVideo(videoId, videoUrl, thumbnailUrl, videoTitle);
                    if (deleted && user) {
                        showChannelPage(user.uid);
                    }
                }
            });
            if(closeEditModalButton) closeEditModalButton.addEventListener('click', closeEditVideoModalHandler);
            if(editVideoForm) editVideoForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const videoId = editVideoIdInput.value;
                const newTitle = editVideoTitleInput.value.trim();
                const newDescription = editVideoDescriptionInput.value.trim();
                const newCategory = editVideoCategoryInput.value;
                const newIsOriginal = editIsStreamsyOriginalCheckbox.checked;
                const newTagsInput = editVideoTagsInput.value.trim();
                const newTags = newTagsInput ? newTagsInput.split(',').map(tag => tag.trim().replace(/^#/, '')).filter(tag => tag !== '') : [];
                if (!videoId || !newTitle) { alert('العنوان مطلوب.'); return; }
                try {
                    await db.collection('videos').doc(videoId).update({ title: newTitle, description: newDescription, category: newCategory || null, tags: newTags, title_lowercase: newTitle.toLowerCase(), isStreamsyOriginal: newIsOriginal });
                    alert('تم تحديث الفيديو بنجاح.');
                    closeEditVideoModalHandler();
                    if(auth.currentUser) {
                        if (channelPageSection && !channelPageSection.classList.contains('hidden') && currentChannelOwnerIdForPage === auth.currentUser.uid) {
                            showChannelPage(auth.currentUser.uid);
                        } else if (videoPlayerSection && !videoPlayerSection.classList.contains('hidden') && currentVideoIdForPlayer === videoId) {
                            // Listener will handle update
                        }
                    }
                } catch (error) { console.error("Error updating video:", error); alert('خطأ أثناء تحديث الفيديو.'); }
            });

            if (playerSubscribeButton) playerSubscribeButton.addEventListener('click', () => {
                const channelId = playerSubscribeButton.dataset.channelId;
                if (channelId) handleSubscription(channelId);
            });
            if (channelPageSubscribeButton) channelPageSubscribeButton.addEventListener('click', () => {
                const channelId = channelPageSubscribeButton.dataset.channelId;
                if (channelId) handleSubscription(channelId);
            });

            if (editChannelButton) editChannelButton.addEventListener('click', openEditChannelModal);
            if (closeEditChannelModalButton) closeEditChannelModalButton.addEventListener('click', closeEditChannelModalHandler);
            [editChannelProfilePictureInput, editChannelCoverPhotoInput].forEach(input => {
                if (input) input.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    const previewElementId = event.target.id === 'edit-channel-profile-picture' ? 'edit-channel-profile-preview' : 'edit-channel-cover-preview';
                    const previewElement = document.getElementById(previewElementId);
                    if (file && previewElement) {
                        const reader = new FileReader();
                        reader.onload = function(e) { previewElement.src = e.target.result; previewElement.classList.remove('hidden'); }
                        reader.readAsDataURL(file);
                    }
                });
            });
            if (editChannelForm) editChannelForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) { editChannelStatus.textContent = 'خطأ: يجب تسجيل الدخول.'; return; }
                submitEditChannelButton.disabled = true; editChannelStatus.textContent = 'جارٍ حفظ التغييرات...';

                const newName = editChannelNameInput.value.trim();
                const newDescription = editChannelDescriptionInput.value.trim();
                const profilePicFile = editChannelProfilePictureInput.files[0];
                const coverPhotoFile = editChannelCoverPhotoInput.files[0];

                let profilePicUrl = user.photoURL;
                let coverPhotoUrl;

                const userDocRef = db.collection('users').doc(user.uid);
                try {
                    const userDocSnap = await userDocRef.get();
                    if (userDocSnap.exists() && userDocSnap.data().channelCoverUrl) { coverPhotoUrl = userDocSnap.data().channelCoverUrl; }
                    else { coverPhotoUrl = ''; }

                    if (profilePicFile) {
                        const profilePicRef = storage.ref(`channel_assets/${user.uid}/profile_${Date.now()}_${profilePicFile.name.replace(/[^a-zA-Z0-9.]/g, '_')}`);
                        await profilePicRef.put(profilePicFile);
                        profilePicUrl = await profilePicRef.getDownloadURL();
                    }
                    if (coverPhotoFile) {
                        const coverPhotoRef = storage.ref(`channel_assets/${user.uid}/cover_${Date.now()}_${coverPhotoFile.name.replace(/[^a-zA-Z0-9.]/g, '_')}`);
                        await coverPhotoRef.put(coverPhotoFile);
                        coverPhotoUrl = await coverPhotoRef.getDownloadURL();
                    }

                    await user.updateProfile({ displayName: newName, photoURL: profilePicUrl });
                    await userDocRef.set({ displayName: newName, photoURL: profilePicUrl, channelDescription: newDescription, channelCoverUrl: coverPhotoUrl }, { merge: true });

                    editChannelStatus.textContent = 'تم حفظ التغييرات بنجاح!';
                    setTimeout(() => { closeEditChannelModalHandler(); showChannelPage(user.uid); }, 1500);
                } catch (error) { console.error("Error updating channel details:", error); editChannelStatus.textContent = `فشل حفظ التغييرات: ${error.message}`;
                } finally { submitEditChannelButton.disabled = false; }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            navigateToHomeView(false, true);
            updateActiveSidebarLink('sidebar-home-button');
            setInitialSidebarTextState();
            loadLiveNowStreams(); // Load live streams on initial page load

            const urlParams = new URLSearchParams(window.location.search);
            const videoIdFromUrl = urlParams.get('videoId');
            const sectionFromUrl = urlParams.get('section');
            const liveStreamUserId = urlParams.get('live'); // New param for live stream

            if (liveStreamUserId) {
                db.collection("liveStreams").doc(liveStreamUserId).get().then(docSnap => {
                    if (docSnap.exists() && docSnap.data().isLive) {
                        const liveData = docSnap.data();
                        playLiveStream(liveStreamUserId, liveData.hlsUrl, liveData.title);
                    } else {
                        alert("البث المباشر المطلوب غير متاح أو انتهى.");
                        navigateToHomeView(false, true);
                    }
                }).catch(err => {
                    console.error("Error fetching live stream from URL param:", err);
                    navigateToHomeView(false, true);
                });
            } else if (videoIdFromUrl) {
                showVideoPlayer(videoIdFromUrl);
            } else if (sectionFromUrl) {
                 if (sectionFromUrl === 'liked') loadLikedVideos();
                 else if (sectionFromUrl === 'history') loadHistoryVideos();
                 else if (sectionFromUrl === 'trending') loadTrendingVideos();
                 else if (sectionFromUrl === 'streams') loadStreamsPage();
                 else if (sectionFromUrl === 'live') { // For viewing list of live streams
                    hideAllMainSections();
                    if (liveNowSection) liveNowSection.classList.remove('hidden');
                    updateActiveSidebarLink('sidebar-live-streams-button');
                    loadLiveNowStreams();
                 }
            }
        });
        window.addEventListener('resize', setInitialSidebarTextState);


    </script>
</body>
</html>
